rgn=(function(a,b,undefined){var s=1026764286;var _s=[];return{'srand':srand,'restore':restore,'rand':rand};function srand(seed,discard){if(!seed){throw new Error('invalid seed given');}_s.push(s);s=seed;if(Number(discard)){for(var i=0;i < Number(discard);i++){_rand();}}}function restore(){if(_s.length){s=_s.pop();return true;}return false;}function _rand(){for(var i=0;i < 32;i++){var t=((s >> a)& 1)^((s >> b)& 1);s=((s << 1)& 2147483647)+t;}return s;}function rand(min,max){if(max===undefined){return _rand();}if(!min){min=0;}if(max==min){return max;}if(max < min){var x=min;min=max;max=x;}return _rand()%(max-min+1)+min;}})(7,29);function createGameFieldUtility(m){var gmd=m;var g_image_data;_initImage();return{'getImg':getImg,'getMaxActCount':getMaxActCount,'getRelativePosId':getRelativePosId,'getFrontPosId':getFrontPosId,'getXYFromPosId':getXYFromPosId,'getPosCodeFromPosId':getPosCodeFromPosId,'getPosIdFromXY':getPosIdFromXY,'getDistance':getDistance,'getMaxHP':getMaxHP,'attackRangeCheck':attackRangeCheck,'isValidSuper':isValidSuper,'loadMonsterInfo':loadMonsterInfo,'getModifyMonsterId':getModifyMonsterId,'myAlertInField':myAlertInField};function _initImage(){try{g_image_data=JSON.parse(localStorage.img_data);}catch(e){$.getJSON('/api/image-json-load/',null,function(r){var dt=new Date();r.upd_date=dt.getTime();g_image_data=r;try{localStorage.img_data=r;}catch(e){}});}}function getImg(img_path){try{if(g_image_data && g_image_data[img_path]){return 'data:image/jpg;base64,'+g_image_data[img_path];}}catch(e){}return img_path;}function getMaxActCount(monster_id){try{var aMonsterData=gmd.m_monster[monster_id];var aCardData=gmd.m_card[aMonsterData.card_id];if(aCardData.category=='master'){return 10000;}else if(aMonsterData.skill.id==4){return 2;}else if(aMonsterData.skill.id==5){return 3;}return 1;}catch(e){return 0;}}function getRelativePosId(sPosId,df){var pos=getXYFromPosId(sPosId);pos.x+=df.x;pos.y+=df.y;return getPosIdFromXY(pos);}function getFrontPosId(sPosId){switch(sPosId){case 'enemyBack2':return 'enemyFront2';break;case 'enemyBack1':return 'enemyFront1';break;case 'enemyFront2':return 'myFront1';break;case 'enemyMaster':return 'myMaster';break;case 'enemyFront1':return 'myFront2';break;case 'myFront1':return 'enemyFront2';break;case 'myMaster':return 'enemyMaster';break;case 'myFront2':return 'enemyFront1';break;case 'myBack1':return 'myFront1';break;case 'myBack2':return 'myFront2';break;}return null;}function getXYFromPosId(sPosId){switch(sPosId){case 'enemyBack2':return{x:0,y:0};break;case 'enemyBack1':return{x:2,y:0};break;case 'enemyFront2':return{x:0,y:1};break;case 'enemyMaster':return{x:1,y:1};break;case 'enemyFront1':return{x:2,y:1};break;case 'myFront1':return{x:0,y:2};break;case 'myMaster':return{x:1,y:2};break;case 'myFront2':return{x:2,y:2};break;case 'myBack1':return{x:0,y:3};break;case 'myBack2':return{x:2,y:3};break;}return null;}function getPosCodeFromPosId(sPosId){switch(sPosId){case 'enemyBack2':return '(d)';break;case 'enemyBack1':return '(c)';break;case 'enemyFront2':return '(b)';break;case 'enemyMaster':return '(m)';break;case 'enemyFront1':return '(a)';break;case 'myFront1':return '(A)';break;case 'myMaster':return '(M)';break;case 'myFront2':return '(B)';break;case 'myBack1':return '(C)';break;case 'myBack2':return '(D)';break;}return '';}function getPosIdFromXY(p){if(p.y==0){if(p.x==0){return 'enemyBack2';}else if(p.x==2){return 'enemyBack1';}}else if(p.y==1){if(p.x==0){return 'enemyFront2';}else if(p.x==1){return 'enemyMaster';}else if(p.x==2){return 'enemyFront1';}}else if(p.y==2){if(p.x==0){return 'myFront1';}else if(p.x==1){return 'myMaster';}else if(p.x==2){return 'myFront2';}}else if(p.y==3){if(p.x==0){return 'myBack1';}else if(p.x==2){return 'myBack2';}}return '';}function getDistance(posId1,posId2){var p1=getXYFromPosId(posId1);var p2=getXYFromPosId(posId2);return Math.max(Math.abs(p1.x-p2.x),Math.abs(p1.y-p2.y));}function getMaxHP(mon){var iMaxHP=gmd.m_monster[mon.monster_id].max_hp;if(!mon.status){return iMaxHP;}if(mon.status[127]){var st=mon.status[127];iMaxHP=gmd.m_monster[st.param1].max_hp;}if(mon.status[128]){var st=mon.status[128];iMaxHP=gmd.m_monster[st.param1].max_hp;}return iMaxHP;}function attackRangeCheck(act,target){try{if(target.pos_category!='field'||!target.pos_id){return false;}if(target.standby_flg){return false;}if(act.status[113]){if(target.pos_id=='myMaster'||target.pos_id=='enemyMaster'){return false;}else{return true;}}else{var aData=gmd.m_monster[act.monster_id];var p1=getXYFromPosId(act.pos_id);var p2=getXYFromPosId(target.pos_id);switch(aData.skill.id){case 23:if(p2.y-p1.y==-1 &&(p2.x-p1.x==0||p2.x-p1.x==-1)){return true;}else{return false;}break;case 24:if(p2.y-p1.y==-1 &&(p2.x-p1.x==0||p2.x-p1.x==1)){return true;}else{return false;}break;default:if(getDistance(act.pos_id,target.pos_id)==1){return true;}else{return false;}break;}}return false;}catch(e){return false;}}function isValidSuper(aArgs){try{var aBefore=aArgs.aBefore;var aAfter=aArgs.aAfter;if(!aBefore||!aAfter){throw new Error('no_target');}if(aBefore.pos_category!='field'||aAfter.owner!=aBefore.owner){throw new Error('invalid_target');}if(typeof aBefore.status[111]!='undefined'||typeof aBefore.status[127]!='undefined'||typeof aBefore.status[128]!='undefined'){throw new Error('invalid_target');}switch(aAfter.pos_category){case 'hand':break;default:throw new Error('invalid_target');break;}var cate=gmd.m_card[aAfter.card_id].category;if(cate!='super_front' && cate!='super_back'){throw new Error('not_super');}if(aArgs.check_lvup_standby && typeof aArgs.lvup_assist!='undefined'){if(aBefore.lvup_standby <=0 && aArgs.lvup_assist <=0){throw new Error('empty_lvup_cost');}}var aMonsterData=gmd.m_monster[aBefore.monster_id];if(aMonsterData.skill.id==15){return true;}var bSuper=false;$.each(aMonsterData.supers,function(i,val){if(val.card_id==aAfter.card_id){bSuper=true;return false;}});if(!bSuper){throw new Error('not_super');}}catch(e){return false;}return true;}function loadMonsterInfo(aArgs){if(!aArgs){throw new Error('argument_error');}if(!aArgs.target_monster){throw new Error('argument_error');}var targetMon=aArgs.target_monster;if(!targetMon){throw new Error('argument_error');}if(!aArgs.monster_id){aArgs.monster_id=targetMon.monster_id;if(!aArgs.monster_id){aArgs.monster_id=gmd.m_card[targetMon.card_id].monster_id;if(!aArgs.monster_id){throw new Error('argument_error');}}}if(!aArgs.pos_id){aArgs.pos_id=targetMon.pos_id;if(!aArgs.pos_id){throw new Error('argument_error');}}if(!aArgs.standby_flg){aArgs.standby_flg=false;}var mon=gmd.m_monster[aArgs.monster_id];targetMon.pos_category='field';targetMon.pos_id=aArgs.pos_id;targetMon.card_id=Number(mon.card_id);targetMon.monster_id=Number(aArgs.monster_id);targetMon.standby_flg=aArgs.standby_flg;targetMon.skill_disable_flg=0;targetMon.sort_no=0;if(typeof targetMon.lvup_standby=='undefined'){targetMon.lvup_standby=0;}if(typeof targetMon.status=='undefined'||aArgs.reset_status){targetMon.status={};}if(aArgs.aBefore){var bfMon=aArgs.aBefore;bfMon.next_game_card_id=targetMon.game_card_id;targetMon.before_game_card_id=Number(bfMon.game_card_id);targetMon.status={};targetMon.act_count=bfMon.act_count;targetMon.lvup_standby=bfMon.lvup_standby;$.extend(true,targetMon.status,bfMon.status);}if(aArgs.reset_hp){targetMon.hp=Number(mon.max_hp);}if(aArgs.reset_act_count){targetMon.act_count=0;}return targetMon;}function getModifyMonsterId(monster_id){var mon=gmd.m_monster[monster_id];var ret_monster_id=null;$.each(gmd.m_monster,function(i,val){if(val.monster_id==mon.monster_id){return true;}if(Number(val.card_id)!=Number(mon.card_id)){return true;}if(Number(val.lv)==Number(mon.lv)){ret_monster_id=val.monster_id;return false;}});return ret_monster_id;}var sGameInfomationMessage='';function myAlertInField(aArgs){if(aArgs.message==sGameInfomationMessage){return;}sGameInfomationMessage=aArgs.message;var param=JSON.parse(localStorage.game_settings);var bAlertPopup=parseInt(param['alert_popup']);if(typeof bAlertPopup=='undefined'){bAlertPopup=true;}$('#game_infomation_frame .info').text(sGameInfomationMessage);if(bAlertPopup && 0 < sGameInfomationMessage.length && !aArgs.no_alert){alert(sGameInfomationMessage);}}};function createGameFieldReactions(){var gmd;var gfd;var g_base_color;var g_sBeforeGameState;var iMyMasterId;var iEnemyMasterId;return{'initMasterData':initMasterData,'actedReaction':actedReaction,'damageReaction':damageReaction,'healReaction':healReaction,'isDuplicateFieldPos':isDuplicateFieldPos,'isLvupOk':isLvupOk,'isProvoked':isProvoked,'updateActorDom':updateActorDom,'updateField':updateField,'artsUsedReaction':artsUsedReaction,'wakeupReaction':wakeupReaction,'getGameCardId':getGameCardId,'checkTargetPosValid':checkTargetPosValid,'checkGameState':checkGameState,'updateGameInfoMessage':updateGameInfoMessage};function initMasterData(aArgs){gmd=aArgs.master_data;gfd=aArgs.field_data;g_base_color=aArgs.base_color;}function updateField(aArgs){gfd=aArgs.field_data;try{var nHand={'my':0,'enemy':0};var aPosId={'myMaster':'#myMaster','myFront1':'#myFront1','myFront2':'#myFront2','myBack1':'#myBack1','myBack2':'#myBack2','enemyMaster':'#enemyMaster','enemyFront1':'#enemyFront1','enemyFront2':'#enemyFront2','enemyBack1':'#enemyBack1','enemyBack2':'#enemyBack2'};var aMyHandHtml=[];var aEnemyHandHtml=[];$('.lvup_ok').removeClass('lvup_ok');$('.lvup_checking').removeClass('lvup_checking');(function _getSortCardHtml(){if(checkGameState()!='sort_card'||!gfd.sorting_cards||gfd.sorting_cards.length <=0){$('.sort_card_frame').remove();return;}else if($('.sort_card_frame').size()<=0){$('#secondary_part').prepend('<div class="sort_card_frame"></div>');}gfd.sorting_cards.sort(function(v1,v2){return v1.sort_no-v2.sort_no;});var sHtml='<div class="sort_card_title">Sort Card</div>';var sNext=' <span class="next_draw">NEXT DRAW</span>';$.each(gfd.sorting_cards,function(i,val){var aCardData=gmd.m_card[gfd.cards[val.game_card_id].card_id];var sImgSrc=gfu.getImg('/images/card/'+aCardData.image_file_name);var sClass='sort_card_target clearfix';if(val.bSelected){sClass+=' selected';}sHtml+='<div class="'+sClass+'" iref="'+i+'">'+'<div class="img_frame"><img class="pict" src="'+sImgSrc+'" alt="'+aCardData.card_name+'" /></div>'+'<div class="main_frame">'+aCardData.card_name+sNext+'</div>'+'<div class="dtl_link"><a class="blank_link" href="/card/detail/'+aCardData.card_id+'/" target="_blank">詳細</a></div>'+'</div>';sNext='';});sHtml+='<div class="sort_end_button_frame">'+'<div class="sort_end_button">'+'これでOK'+'</div>'+'</div>';$('.sort_card_frame').html(sHtml);})();$.each(gfd.cards,function(i,val){switch(val.pos_category){case 'field':if(val.next_game_card_id){break;}var sImgSrc='/images/card/card.jpg';var sImgAlt='カードヒーロー';var sImgClass='card_image';var sLv='?';var sLvHp='<span class="mini-font">LV</span><span class="lv">?</span>';sLvHp+='<span class="mini-font">HP</span><span class="hp">?</span>';if(!val.standby_flg){sImgSrc='/images/card/';if(gfd.old_queues.length){}else{if(val.owner=='my' && gfu.getMaxActCount(val.monster_id)<=val.act_count){sImgClass+=' gray';}}sImgSrc+=gmd.m_monster[val.monster_id].image_file_name;sImgAlt=gmd.m_monster[val.monster_id].name;sLv=gmd.m_monster[val.monster_id].lv;sLvHp='<span class="mini-font">LV</span><span class="lv">'+sLv+'</span>';sLvHp+='<span class="mini-font">HP</span><span class="hp">'+val.hp+'</span>';}var aEffectFlags={'P':false,'S':false,'M':false,'!':false};$.each(val.status,function(sid,aStatus){var aSt=gmd.m_status[sid];aEffectFlags[aSt.status_type]=true;});var sStatusEffect='';if(aEffectFlags['P']){sStatusEffect+='<span class="power">P</span>';}if(aEffectFlags['S']){sStatusEffect+='<span class="shield">S</span>';}if(aEffectFlags['M']){sStatusEffect+='<span class="magic">M</span>';}if(aEffectFlags['!']){sStatusEffect+='<span class="charge">！</span>';}var bLvupOk=isLvupOk(val,{bCheckLvupCnt:true});if(bLvupOk){$('#game_field td').addClass('lvup_checking');$('#game_field td#'+val.pos_id).addClass('lvup_ok');}else if(0 < val.lvup_standby){gfd.queues.push({actor_id:val.game_card_id,log_message:'',resolved_flg:0,priority:'same_time',actor_anime_disable:true,queue_units:[{queue_type_id:1018}]});}sImgSrc=gfu.getImg(sImgSrc);$('#game_field td#'+val.pos_id).html('<div class="pict">'+'<img class="'+sImgClass+'" src="'+sImgSrc+'" alt="'+sImgAlt+'"/>'+'</div>'+'<div class="param">'+sLvHp+'<br />'+sStatusEffect+'</div>');delete aPosId[val.pos_id];break;case 'hand':nHand[val.owner]++;var aCardData=gmd.m_card[val.card_id];var sImgSrc='/images/card/'+gmd.m_card[val.card_id].image_file_name;var sImgAlt=aCardData.card_name;var sMagicAttr='';sImgSrc=gfu.getImg(sImgSrc);var oHandHtml={sort_no:Number(val.sort_no),content:'<div class="hand_card" game_card_id="'+val.game_card_id+'">'+'<img src="'+sImgSrc+'" alt="'+sImgAlt+'"/>'+'</div>'};if(val.owner=='my'){aMyHandHtml.push(oHandHtml);}else{aEnemyHandHtml.push(oHandHtml);}break;}});var _fSort=function(v1,v2){try{if(!v1||!v1.sort_no){return-1;}else if(!v2||!v2.sort_no){return 1;}else{return v1.sort_no-v2.sort_no;}}catch(e){return 0;}};aMyHandHtml.sort(_fSort);aEnemyHandHtml.sort(_fSort);$.each(aPosId,function(i,sPosId){$(sPosId).html('<div class="pict"></div>');});var sHtml='';$.each(aMyHandHtml,function(i,val){sHtml+=val.content;});(function _dispEnemyHand(){var bDisp=false;if(gfd.replay_flg){bDisp=true;}if(bDisp){var sEneHand='';$.each(aEnemyHandHtml,function(i,val){sEneHand+=val.content;});if($('#eneHand').size()){$('#eneHand').html(sEneHand);}else{$('#game_field').before('<div id="eneHand" class="clearfix">'+sEneHand+'</div>');}}})();$('#hand_card').html(sHtml);$('#myPlayersInfo .stone span').text(gfd.my_stone);$('#myPlayersInfo .hand span').text(nHand['my']);$('#enemyPlayersInfo .stone span').text(gfd.enemy_stone);$('#enemyPlayersInfo .hand span').text(nHand['enemy']);updateActorDom(aArgs);}catch(e){throw e;}}function updateActorDom(aArgs){$('.target').removeClass('target');if(typeof aArgs=='undefined'){aArgs={'field_data':gfd};}if(typeof aArgs.game_state=='undefined'){aArgs.game_state=checkGameState();}gfd=aArgs.field_data;try{var _buildArtsRow=function(mon){var aMonsterData=gmd.m_monster[mon.monster_id];$.each(aMonsterData.arts,function(i,val){var sPower='';var iPow=Number(val.power);var sImgSrc='/images/range/'+val.range_type_id+'.png';sImgSrc=gfu.getImg(sImgSrc);var sRange='<img src="'+sImgSrc+'" alt="" />';var iStone=val.stone;if(val.damage_type_flg=='P' && typeof mon.status!='undefined'){$.each(mon.status,function(sid,aSt){switch(Number(sid)){case 101:case 102:iPow++;break;case 103:iPow=2;break;case 104:iPow--;break;case 105:iPow+=2;break;}});}if(val.damage_type_flg=='P'||val.damage_type_flg=='D'||val.damage_type_flg=='HP'){switch(val.script_id){case 1012:case 1013:case 1020:case 1026:sPower='?'+val.damage_type_flg;break;default:sPower=''+iPow+''+val.damage_type_flg;break;}}else if(val.script_id==1041){sPower='2?';}if(typeof mon.status!='undefined'){if(typeof mon.status[120]!='undefined' && mon.status[120].param1==val.id){iStone *=2;}if(typeof mon.status[123]!='undefined'){iStone+=2;}}sCommandsHtml+='<div class="command_row" art_id="'+val.id+'" act_type="arts">'+val.name+'<div class="num_info">'+'<span class="range_pic">'+sRange+'</span>'+' '+sPower+' '+'<span class="stone_cost">'+iStone+'コ'+'</span>'+'</div>'+'</div>';});};if(!gfd.actor.game_card_id){throw 'no_actor';}var aCard=gfd.cards[gfd.actor.game_card_id];var aCardData=gmd.m_card[aCard.card_id];var sImgSrc='/images/card/'+aCardData.image_file_name;sImgSrc=gfu.getImg(sImgSrc);var sImageAlt=aCardData.card_name;if(aCard.monster_id){sImageFileName=gmd.m_monster[aCard.monster_id].image_file_name;sImageAlt=gmd.m_monster[aCard.monster_id].monster_name;}var sImg='<img src="'+sImgSrc+'" alt="'+sImageAlt+'" />';var sProposer='';if(aCardData.proposer){sProposer='<div class="proposer"> Arranged&nbsp;</div>';}var sStatusLink='';var sDtlLink='<a class="blank_link" target="_blank" href="/card/detail/'+aCardData.card_id+'/">詳細</a>';var sCommandsHtml='';var _buildUsedCardsRow=function(selectedOwner){var aUsedCards=[];var iDeck=0;var iUsed=0;$.each(gfd.cards,function(l,val){if(val.owner!=selectedOwner){return true;}if(val.pos_category=='deck'){iDeck++;}if(val.pos_category!='used'){return true;}iUsed++;var ac=gmd.m_card[val.card_id];var sImgSrc=gfu.getImg('/images/card/'+ac.image_file_name);aUsedCards.push({'sort_no':val.sort_no,'sHtml':'<div>'+'<img src="'+sImgSrc+'" />'+ac.card_name+'<div class="num_info">'+'<a class="blank_link" href="/card/detail/'+ac.card_id+'/" target="_blank">詳細</a>'+'&nbsp;'+'</div>'+'</div>'});});aUsedCards.sort(function(v1,v2){return v2.sort_no-v1.sort_no;});var sUsedCards='';for(var i=0;i < aUsedCards.length;i++){sUsedCards+=aUsedCards[i].sHtml;}var sUsedHtml='<div class="around_card_info">'+'山札：'+iDeck+'枚&nbsp;&nbsp;'+'墓地：'+iUsed+'枚<br />'+'<a href="javascript:void(0);" class="check_used">墓地確認↓</a>'+'<div class="used_cards_div" style="display:none;">'+sUsedCards+'</div>'+'</div>';return sUsedHtml;};if(aCard.pos_category=='hand'){if(aArgs.game_state=='tokugi_fuuji'){aCard=gfd.cards[gfd.actor.aTargets[0].game_card_id];var mon=gmd.m_monster[aCard.monster_id];sImg='<img src="'+sImgSrc+'" alt="'+sImageAlt+'" />';if(aCard.owner=='enemy' && aCard.standby_flg){throw new Error('standby monster');}_buildArtsRow(aCard);}else{switch(aCardData.category){case 'monster_front':case 'monster_back':gfd.actor.act_type='into_field';sCommandsHtml='<div class="command_row into_field selected_act" act_type="into_field">'+'場に出す'+'</div>';break;case 'magic':var aMagicData=gmd.m_magic[aCardData.magic_id];var mid=aCardData.magic_id;var iStone=aMagicData.stone;var aMaster=getGameCardId({pos_category:'field',pos_id:'myMaster'});try{if(aMaster.status[123]){iStone+=2;}}catch(e){}switch(aCardData.card_name){case 'ローテーション':sCommandsHtml='<div class="command_row" act_type="magic" magic_id="'+mid+'" param1="1">'+'時計回り'+' '+'<div class="num_info">'+'<span class="stone_cost">'+iStone+'コ'+'</span>'+'</div>'+'</div>'+'<div class="command_row" act_type="magic" magic_id="'+mid+'" param1="2">'+'反時計回り'+' '+'<div class="num_info">'+'<span class="stone_cost">'+iStone+'コ'+'</span>'+'</div>'+'</div>';break;case 'カードサーチ':sCommandsHtml='<div class="command_row" act_type="magic" magic_id="'+mid+'" param1="front">'+'前衛モンスターをサーチ'+' '+'<div class="num_info">'+'<span class="stone_cost">'+iStone+'コ'+'</span>'+'</div>'+'</div>'+'<div class="command_row" act_type="magic" magic_id="'+mid+'" param1="back">'+'後衛モンスターをサーチ'+' '+'<div class="num_info">'+'<span class="stone_cost">'+iStone+'コ'+'</span>'+'</div>'+'</div>'+'<div class="command_row" act_type="magic" magic_id="'+mid+'" param1="magic">'+'マジックをサーチ'+' '+'<div class="num_info">'+'<span class="stone_cost">'+iStone+'コ'+'</span>'+'</div>'+'</div>'+'<div class="command_row" act_type="magic" magic_id="'+mid+'" param1="super">'+'スーパーをサーチ'+' '+'<div class="num_info">'+'<span class="stone_cost">'+iStone+'コ'+'</span>'+'</div>'+'</div>';break;case 'ドロー５':if(!gfd.no_arrange){iStone='?';}default:gfd.actor.magic_id=mid;gfd.actor.act_type='magic';sCommandsHtml='<div class="command_row magic selected_act" magic_id="'+mid+'" act_type="magic">'+'発動'+' '+'<div class="num_info">'+'<span class="stone_cost">'+iStone+'コ'+'</span>'+'</div>'+'</div>';if(gmd.m_magic[aCardData.magic_id].magic_type=='D'){sCommandsHtml+=_buildUsedCardsRow(aCard.owner);}break;}break;case 'super_front':case 'super_back':break;}}}else if(aCard.pos_category=='field'){if(aArgs.game_state=='lvup_standby'){if(aCard.owner=='enemy' && aCard.standby_flg){throw new Error('standby monster');}var aMonsterData=gmd.m_monster[aCard.monster_id];var sCommandName=null;if(0 < aCard.lvup_standby||0 < gfd.lvup_assist){if(aMonsterData.next_monster_id){sCommandName='レベルアップ';}try{$.each(gfd.cards,function(i,val){var bSuper=gfu.isValidSuper({aBefore:aCard,aAfter:val});if(bSuper){throw 'super_ok';}});}catch(e){if(e=='super_ok'){sCommandName='スーパーに進化';}else{throw e;}}}if(sCommandName){sCommandsHtml='<div class="command_row" act_type="lvup">'+sCommandName+'</div>';}}else if(aArgs.game_state=='tokugi_fuuji'){aCard=gfd.cards[gfd.actor.aTargets[0].game_card_id];var mon=gmd.m_monster[aCard.monster_id];var sImgSrc='/images/card/'+mon.image_file_name;sImgSrc=gfu.getImg(sImgSrc);sImg='<img src="'+sImgSrc+'" alt="'+sImageAlt+'" />';if(aCard.owner=='enemy' && aCard.standby_flg){throw new Error('standby monster');}_buildArtsRow(aCard);}else{var aMonsterData=gmd.m_monster[aCard.monster_id];if(aCard.owner=='enemy' && aCard.standby_flg){throw new Error('standby monster');}var sCost='';var aNumbers={iPow:parseInt(aMonsterData.attack.power),iStone:parseInt(aMonsterData.attack.stone)};if(aCard.status){if(aCard.status[123]){aNumbers.iStone+=2;}$.each(aCard.status,function(iSt,aSt){switch(Number(iSt)){case 100:case 101:case 102:aNumbers.iPow++;break;case 103:aNumbers.iPow=22222;break;case 104:aNumbers.iPow--;break;case 105:case 130:aNumbers.iPow+=2;break;case 131:aNumbers.iPow+=Number(aSt.param1);break;default:break;}switch(gmd.m_status[iSt].status_type){case 'P':case 'S':case 'M':sStatusLink='<a href="javascript:void(0)" game_card_id="'+aCard.game_card_id+'" class="check_magic_effect">魔法効果確認</a>';break;}});if(20000 < aNumbers.iPow){aNumbers.iPow=2;}}if(aNumbers.iStone > 0){sCost=' '+'<span class="stone_cost">'+aNumbers.iStone+'コ'+'</span>';}sCommandsHtml='<div class="command_row" act_type="attack">'+aMonsterData.attack.name+'<div class="num_info">'+aNumbers.iPow+'P'+sCost+'</div>'+'</div>';_buildArtsRow(aCard);var sCost='';var iStone=0;if(!aCard.status){aCard.status={};}if(aCard.status[123]){iStone+=2;}if(iStone > 0){sCost=' '+'<span class="stone_cost">'+iStone+'コ'+'</span>';}if(aCardData.category=='master'){if(aCard.status[132]){sCommandsHtml+='<div class="command_row" act_type="marigan">'+'マリガン'+'<div class="num_info">'+sCost+'</div>'+'</div>';}else if(gfd.no_arrange){sCommandsHtml+='<div class="command_row" act_type="make_card">'+'メイクカード'+'<div class="num_info">'+sCost+'</div>'+'</div>';}sCommandsHtml+='<div class="command_row" act_type="surrender">'+'降参'+'</div>';sCommandsHtml+=_buildUsedCardsRow(aCard.owner);}else{if(gfd.no_arrange){switch(gmd.m_monster[aCardData.monster_id].skill.id){case 4:case 5:sCommandsHtml+='<div class="command_row" act_type="charge">'+'気合だめ'+'<div class="num_info">'+sCost+'</div>'+'</div>';break;}}sCommandsHtml+='<div class="command_row" act_type="move">'+'移動'+'<div class="num_info">'+sCost+'</div>'+'</div>';if(gfd.no_arrange){sCommandsHtml+='<div class="command_row" act_type="escape">'+'逃げる'+'<div class="num_info">'+sCost+'</div>'+'</div>';}}}}var sCardName=aCardData.card_name;if(aCard.monster_id){sCardName=gmd.m_monster[aCard.monster_id].name;}$('#card_info_frame').html('<div class="card_info_title clearfix">'+'<div class="card_infomation">Card Infomation</div>'+sProposer+'</div>'+'<div class="card_summary clearfix">'+'<div class="card_image">'+sImg+'</div>'+'<div class="card_name">'+toKanaZenkaku(sCardName)+'<br />'+sStatusLink+'</div>'+'<div class="dtl_link">'+sDtlLink+'</div>'+'</div>'+'<div class="act_commands">'+sCommandsHtml+'</div>');}catch(e){if(e!='no_actor'){}$('.actor').removeClass('actor');$('#card_info_frame').html('<div class="card_info_title">'+'Card Infomation'+'</div>'+'<div class="card_summary clearfix">'+'<div class="card_image"></div>'+'<div class="card_name"></div>'+'<div class="dtl_link"></div>'+'</div>'+'<div class="act_commands">'+'</div>');}if(gfd.queues.length <=0 && gfd.old_queues.length <=0){updateGameInfoMessage();}}function isLvupOk(mon,aOption){var aOption=aOption||{};if(aOption.bCheckLvupCnt && mon.lvup_standby <=0 && gfd.lvup_assist <=0){return false;}if(mon.standby_flg){return false;}if(mon.status){if(mon.status[111]){return false;}if(mon.status[127]){return false;}if(mon.status[128]){return false;}}var aMonsterData=gmd.m_monster[mon.monster_id];if(aMonsterData.next_monster_id){return true;}try{$.each(gfd.cards,function(i2,vval){var bSuper=gfu.isValidSuper({aBefore:mon,aAfter:vval});if(bSuper){throw 'super_ok';}});}catch(e){if(e=='super_ok'){return true;}else{throw e;}}return false;}function damageReaction(aArgs){gfd=aArgs.field_data;var act=gfd.cards[aArgs.actor_id];var target=gfd.cards[aArgs.target_id];if(target.pos_category!='field'){throw new Error('invalid_target');}if(!target.status){target.status={};}if(0 < aArgs.damage &&(target.pos_id=='myMaster'||target.pos_id=='enemyMaster')){gfd.queues.push({actor_id:null,log_message:'ダメージをストーンに還元',resolved_flg:0,priority:'same_time',queue_units:[{queue_type_id:1004,target_id:target.game_card_id,param1:aArgs.damage}]});$('#'+target.pos_id).append('<div class="fukidasi temp_animation" style="display:none;">-'+aArgs.damage+'</div>');gfd.animation_info.animations.push({target_dom:'.fukidasi',css_param:{'display':'block'}});}if(target.status[109] && act){if(gfu.getDistance(act.pos_id,target.pos_id)==1 && !act.status[109]){gfd.queues.push({actor_id:aArgs.target_id,log_message:'竜の盾による反撃',resolved_flg:0,priority:'follow_damage',queue_units:[{queue_type_id:1005,target_id:aArgs.actor_id,param1:1}]});}}if(aArgs.attack_flg && act.status[113]){gfd.queues.push({actor_id:act.game_card_id,log_message:'',resolved_flg:0,actor_anime_disable:true,priority:'follow',queue_units:[{queue_type_id:1027,target_id:act.game_card_id,param1:113}]});}if(0 < aArgs.damage && target.status[119]){gfd.queues.push({actor_id:act.game_card_id,log_message:'',resolved_flg:0,actor_anime_disable:true,priority:'command',queue_units:[{queue_type_id:1006,target_id:target.status[119].param1,param1:aArgs.damage}]});gfd.queues.push({actor_id:act.game_card_id,log_message:'',resolved_flg:0,actor_anime_disable:true,priority:'reaction',queue_units:[{queue_type_id:1027,target_id:target.game_card_id,param1:119}]});}if(0 < aArgs.damage && 0 < target.hp){if(!target.skill_disable_flg){var targetMonsterData=gmd.m_monster[target.monster_id];var iFrontCardId=getGameCardId({pos_category:'field',pos_id:gfu.getFrontPosId(target.pos_id)});var bFrontStandby=(function(){try{var ret=gfd.cards[iFrontCardId].standby_flg;if(!ret){ret=false;}}catch(e){return false;}return ret;})();var bReactionPushed=false;switch(targetMonsterData.skill.id){case 16:gfd.queues.push({actor_id:target.game_card_id,log_message:'仮死　発動',resolved_flg:0,priority:'reaction',queue_units:[{queue_type_id:1021,target_id:target.game_card_id,param1:gfu.getModifyMonsterId(target.monster_id)},{queue_type_id:1029,target_id:target.game_card_id},]});bReactionPushed=true;break;case 17:var sBackPosId=null;if(target.owner=='my'){sBackPosId=gfu.getRelativePosId(target.pos_id,{x:0,y:1});}else{sBackPosId=gfu.getRelativePosId(target.pos_id,{x:0,y:-1});}gfd.queues.push({actor_id:target.game_card_id,log_message:'撤退　発動',resolved_flg:0,priority:'reaction',queue_units:[{queue_type_id:1022,target_id:target.game_card_id,param1:sBackPosId}]});gfd.queues.push({actor_id:target.game_card_id,log_message:'',resolved_flg:0,priority:'reaction',actor_anime_disable:true,queue_units:[{queue_type_id:1029,target_id:target.game_card_id}]});bReactionPushed=true;break;case 18:if(iFrontCardId && !bFrontStandby){gfd.queues.push({actor_id:target.game_card_id,log_message:'献身　発動',resolved_flg:0,priority:'reaction',queue_units:[{queue_type_id:1007,target_id:iFrontCardId,param1:1},{queue_type_id:1029,target_id:target.game_card_id},]});bReactionPushed=true;}break;case 21:gfd.queues.push({actor_id:target.game_card_id,log_message:'ダメージ呪い発動',resolved_flg:0,priority:'reaction',queue_units:[{queue_type_id:1026,target_id:act.game_card_id,param1:122}]});break;case 22:if(gfu.attackRangeCheck(act,target)){gfd.queues.push({actor_id:target.game_card_id,log_message:'反撃　発動',resolved_flg:0,priority:'react_damage',queue_units:[{queue_type_id:1001,target_id:act.game_card_id},{queue_type_id:1029,target_id:target.game_card_id},]});bReactionPushed=true;}break;case 25:if(iFrontCardId && !bFrontStandby){gfd.queues.push({actor_id:target.game_card_id,log_message:'やつあたり　発動',resolved_flg:0,priority:'react_damage',queue_units:[{queue_type_id:1001,target_id:iFrontCardId},{queue_type_id:1029,target_id:target.game_card_id},]});bReactionPushed=true;}break;}if(bReactionPushed){gfd.queues.push({actor_id:target.game_card_id,log_message:'',resolved_flg:0,priority:'same_time',actor_anime_disable:true,queue_units:[{queue_type_id:1028,target_id:target.game_card_id}]});}}if(target.status){$.each(target.status,function(iSt,vSt){switch(Number(iSt)){case 129:gfd.queues.push({actor_id:target.game_card_id,log_message:vSt.status_name+'消滅',resolved_flg:0,priority:'follow',queue_units:[{queue_type_id:1027,target_id:target.game_card_id,param1:iSt}]});break;}});}}if(target.hp <=0){var targetMonsterData=gmd.m_monster[target.monster_id];if(!target.skill_disable_flg){var bReactionPushed=false;switch(targetMonsterData.skill.id){case 19:gfd.queues.push({actor_id:target.game_card_id,log_message:'ストーン呪い発動',resolved_flg:0,priority:'reaction',queue_units:[{queue_type_id:1026,target_id:act.game_card_id,param1:123}]});break;case 20:gfd.queues.push({actor_id:target.game_card_id,log_message:'ダメージ呪い発動',resolved_flg:0,priority:'reaction',queue_units:[{queue_type_id:1026,target_id:act.game_card_id,param1:122}]});break;}switch(targetMonsterData.skill.id){case 6:case 14:var sLog=(function(i){switch(i){case 6:return '転生 発動';case 14:return '復活 発動';}return '';})(targetMonsterData.skill.id);var iNextMonsterId=gfu.getModifyMonsterId(target.monster_id);gfd.queues.push({actor_id:act.game_card_id,log_message:sLog,resolved_flg:0,actor_anime_disable:true,priority:'reaction',queue_units:[{queue_type_id:1021,target_id:target.game_card_id,param1:iNextMonsterId,param2:true}]});break;default:gfd.queues.push({actor_id:act.game_card_id,log_message:targetMonsterData.name+'は倒れた',resolved_flg:0,actor_anime_disable:true,priority:'react_system',queue_units:[{queue_type_id:1008,target_id:target.game_card_id}]});break;}}else{gfd.queues.push({actor_id:act.game_card_id,log_message:targetMonsterData.name+'は倒れた',resolved_flg:0,actor_anime_disable:true,priority:'react_system',queue_units:[{queue_type_id:1008,target_id:target.game_card_id}]});}if(aArgs.priority=='command'){if(act.owner==target.owner){if(0 < aArgs.damage && act.game_card_id!=target.game_card_id){gfd.queues.push({actor_id:act.game_card_id,log_message:'味方を倒したのでペナルティ',resolved_flg:0,actor_anime_disable:true,priority:'react_system',queue_units:[{queue_type_id:1023,target_id:act.game_card_id,param1:1}]});}}else{var targetMonsterData=gmd.m_monster[target.monster_id];gfd.queues.push({actor_id:act.game_card_id,log_message:'',resolved_flg:0,actor_anime_disable:true,priority:'react_system',queue_units:[{queue_type_id:1017,target_id:act.game_card_id,param1:targetMonsterData.lv}]});}}}var sDom='#'+target.pos_id;gfd.animation_info.animations.push({target_dom:sDom,css_param:{'background-color':'#f00'},animation_param:{'background-color':g_base_color.background}});if(typeof act.monster_id!='undefined' && !act.skill_disable_flg){var actorMon=gmd.m_monster[act.monster_id];switch(actorMon.skill.id){case 1:case 2:case 3:if(aArgs.attack_flg){var dam=2;if(actorMon.skill.id==2){dam=3;}else if(actorMon.skill.id==3){dam=6;}gfd.queues.push({actor_id:act.game_card_id,log_message:'自爆による反動ダメージ',resolved_flg:0,priority:'same_time',actor_anime_disable:true,queue_units:[{queue_type_id:1006,target_id:act.game_card_id,param1:dam}]});}break;case 8:gfd.queues.push({actor_id:act.game_card_id,log_message:'HP吸収',resolved_flg:0,priority:'follow',queue_units:[{queue_type_id:1007,target_id:act.game_card_id,param1:aArgs.damage}]});break;}}return true;}function healReaction(aArgs){gfd=aArgs.field_data;var mon=gfd.cards[aArgs.target_id];var aMonsterData=gmd.m_monster[mon.monster_id];var bReactionPushed=false;if(!mon.skill_disable_flg){switch(aMonsterData.skill.id){case 9:gfd.queues.push({actor_id:aArgs.target_id,log_message:'ヒールアップ　発動',resolved_flg:0,priority:'reaction',queue_units:[{queue_type_id:1026,param1:101,target_id:aArgs.target_id},{queue_type_id:1028,target_id:aArgs.target_id}]});bReactionPushed=true;break;}}if(bReactionPushed){gfd.queues.push({actor_id:aArgs.target_id,log_message:'',resolved_flg:0,priority:'same_time',queue_units:[{queue_type_id:1029,target_id:aArgs.target_id}]});}}function artsUsedReaction(aArgs){gfd=aArgs.field_data;var act=gfd.cards[aArgs.actor_id];var aMonsterData=gmd.m_monster[act.monster_id];var bReactionPushed=false;if(typeof act.skill_disable_flg=='undefined'||!act.skill_disable_flg){switch(aMonsterData.skill.id){case 7:gfd.queues.push({actor_id:act.game_card_id,log_message:'',resolved_flg:0,actor_anime_disable:true,priority:'reaction',queue_units:[{queue_type_id:1008,target_id:act.game_card_id}]});break;case 10:gfd.queues.push({actor_id:act.game_card_id,log_message:'ロロは飛び去った',resolved_flg:0,priority:'reaction',queue_units:[{queue_type_id:1021,target_id:act.game_card_id,param1:gfu.getModifyMonsterId(act.monster_id),param2:false}]});break;case 12:gfd.queues.push({actor_id:act.game_card_id,log_message:'性格「後退」発動',resolved_flg:0,actor_anime_disable:true,priority:'reaction',queue_units:[{queue_type_id:1022,target_id:act.game_card_id,param1:gfu.getRelativePosId(act.pos_id,{x:0,y:1})}]});break;}}}function wakeupReaction(aArgs){gfd=aArgs.field_data;var act=gfd.cards[aArgs.actor_id];var target=gfd.cards[aArgs.target_id];var aMonsterData=gmd.m_monster[target.monster_id];var bReactionPushed=false;if(typeof target.skill_disable_flg=='undefined'||!target.skill_disable_flg){switch(aMonsterData.skill.id){case 23:case 24:gfd.queues.push({actor_id:aArgs.target_id,log_message:'特技チャージ',resolved_flg:0,priority:'reaction',queue_units:[{queue_type_id:1026,param1:133,target_id:aArgs.target_id},{queue_type_id:1029,target_id:aArgs.target_id}]});bReactionPushed=true;break;case 26:if(gfd.no_arrange){if(rgn.rand(0,1)){sLogMessage='きまぐれによりパワーアップ';iStatusType=101;}else{sLogMessage='きまぐれによりパワーダウン';iStatusType=104;}gfd.queues.push({actor_id:aArgs.target_id,log_message:sLogMessage,resolved_flg:0,priority:'reaction',queue_units:[{queue_type_id:1026,param1:iStatusType,target_id:aArgs.target_id},{queue_type_id:1029,target_id:aArgs.target_id}]});bReactionPushed=true;}break;case 28:gfd.queues.push({actor_id:aArgs.target_id,log_message:'ホロウによりストーン呪い',resolved_flg:0,priority:'reaction',queue_units:[{queue_type_id:1026,param1:123,target_id:aArgs.target_id},{queue_type_id:1029,target_id:aArgs.target_id}]});bReactionPushed=true;break;case 29:if(typeof aArgs.system_flg=='undefined'){throw new Error('argument_error');}if(!aArgs.system_flg){var mon=gfd.cards[aArgs.target_id];var posId='enemyMaster';if(mon.owner=='my'){posId='myMaster';}var mst=getGameCardId({pos_category:'field',pos_id:posId});gfd.queues.push({actor_id:aArgs.target_id,log_message:'ウェイク還元によりストーン２個を還元',resolved_flg:0,priority:'reaction',queue_units:[{queue_type_id:1004,param1:2,target_id:aArgs.target_id},{queue_type_id:1029,target_id:aArgs.target_id}]});bReactionPushed=true;}break;}if(bReactionPushed){gfd.queues.push({actor_id:aArgs.target_id,log_message:'',resolved_flg:0,priority:'same_time',actor_anime_disable:true,queue_units:[{queue_type_id:1028,target_id:aArgs.target_id}]});}}}function actedReaction(aArgs){var targetMon=gfd.cards[aArgs.target_id];if(targetMon.status){if(targetMon.status[100]){gfd.queues.push({actor_id:aArgs.target_id,log_message:'気合溜め解除',resolved_flg:0,priority:'same_time',actor_anime_disable:true,queue_units:[{queue_type_id:1027,param1:100,target_id:aArgs.target_id}]});}if(targetMon.status[112]){gfd.queues.push({actor_id:aArgs.target_id,log_message:'水晶の壁解除',resolved_flg:0,priority:'follow',queue_units:[{queue_type_id:1027,param1:112,target_id:aArgs.target_id}]});}if(targetMon.status[122]){if(1 < targetMon.hp){gfd.queues.push({actor_id:aArgs.target_id,log_message:'ダメージ呪い発動',resolved_flg:0,priority:'follow_damage',queue_units:[{queue_type_id:1006,param1:-1,param2:'damage_noroi',target_id:aArgs.target_id}]});}}}var iMasterId=getGameCardId({pos_category:'field',pos_id:'myMaster'});targetMon=gfd.cards[iMasterId];if(targetMon && targetMon.status && targetMon.status[132]){gfd.queues.push({actor_id:iMasterId,log_message:'マリガン無効化',resolved_flg:0,priority:'same_time',actor_anime_disable:true,queue_units:[{queue_type_id:1027,param1:132,target_id:iMyMasterId}]});}}function isDuplicateFieldPos(aArgs){gfd=aArgs.field_data;var aPosId={};try{$.each(gfd.cards,function(i,val){if(val.pos_category!='field'){return true;}if(val.next_game_card_id){return true;}if(typeof aPosId[val.pos_id]!='undefined'){throw new Error('duplicate_field_pos');}aPosId[val.pos_id]=val.pos_id;});}catch(e){if(e=='duplicate_field_pos'){return true;}else{throw e;}}return false;}function getGameCardId(aArgs){try{var iRetGameCardId=null;var aFirstInfo=null;var aLastInfo=null;$.each(gfd.cards,function(l,val){if(val.pos_category!=aArgs.pos_category){return true;}if(aArgs.owner){if(aArgs.owner!=val.owner){return true;}}switch(aArgs.pos_category){case 'field':if(val.pos_id==aArgs.pos_id){if(val.next_game_card_id){iRetGameCardId=val.next_game_card_id;}else{iRetGameCardId=l;}if(aArgs.pos_id=='myMaster'){iMyMasterId=iRetGameCardId;}else if(aArgs.pos_id=='enemyMaster'){iEnemyMasterId=iRetGameCardId;}return false;}break;case 'deck':case 'hand':case 'used':if(aFirstInfo==null||aLastInfo==null){aFirstInfo={sort_no:val.sort_no,game_card_id:l};aLastInfo={sort_no:val.sort_no,game_card_id:l};}else{if(parseInt(val.sort_no)< parseInt(aFirstInfo.sort_no)){aFirstInfo={sort_no:val.sort_no,game_card_id:l};}if(parseInt(aLastInfo.sort_no)< parseInt(val.sort_no)){aLastInfo={sort_no:val.sort_no,game_card_id:l};}}break;default:break;}});if(aArgs.sort_type=='first'){iRetGameCardId=aFirstInfo.game_card_id;}else if(aArgs.sort_type=='last'){iRetGameCardId=aLastInfo.game_card_id;}if(isNaN(iRetGameCardId)){throw new Error('game_card_id couldn\'t get.');}return iRetGameCardId;}catch(e){return null;}}function isProvoked(aArgs){try{var mon=gfd.cards[aArgs.game_card_id];var aMonsterData=gmd.m_monster[mon.monster_id];var aProvoker=gfd.cards[mon.status[117].param1];if(mon.pos_category!='field'){return false;}if(aProvoker.status[118].param1!=mon.game_card_id){return false;}var iRangeType=0;if(mon.status[113]){iRangeType=7;}if(checkTargetPosValid({range_type_id:iRangeType,actor_id:mon.game_card_id,target_id:aProvoker.game_card_id})){return true;}var bArt=false;$.each(aMonsterData.arts,function(iArtId,val){if(val.damage_type_flg!='P' && val.damage_type_flg!='D'){return true;}if(mon.status[110]){if(mon.status[110].param1==iArtId){return true;}}var iStone=val.stone;if(mon.status[120]){if(mon.status[120].param1==iArtId){iStone *=2;}}if(mon.status[123]){iStone+=2;}if(mon.owner=='my'){if(gfd.my_stone < iStone){return true;}}else{if(gfd.enemy_stone < iStone){return true;}}if(checkTargetPosValid({range_type_id:val.range_type_id,actor_id:mon.game_card_id,target_id:aProvoker.game_card_id})){bArt=true;return false;}});return bArt;}catch(e){}return false;}function checkTargetPosValid(aArgs){try{if(typeof aArgs.target_order!='undefined'){switch(aArgs.range_type_id){case 35:break;default:if(1 < aArgs.target_order){return false;}break;}switch(aArgs.range_type_id){case 16:if(aArgs.target_order==0){if(gfd.cards[aArgs.target_id].owner!='my'){return false;}}else if(aArgs.target_order==1){if(gfd.cards[aArgs.target_id].owner!='enemy'){return false;}}aArgs.range_type_id=7;break;case 27:case 29:aArgs.range_type_id=6;break;case 34:if(aArgs.target_order==0){aArgs.range_type_id=15;}break;}}if(aArgs.art_flg){var _searchMonsterHavingSkill=function(skill_id){var ret=null;$.each(gfd.cards,function(l,val){if(val.pos_category!='field'){return true;}if(val.next_game_card_id){return true;}if(val.standby_flg){return true;}if(!val.monster_id){return true;}var aMonsterData=gmd.m_monster[val.monster_id];if(aMonsterData.skill){if(aMonsterData.skill.id==skill_id){ret=l;return false;}}});return ret;};switch(gmd.m_monster[gfd.cards[aArgs.actor_id].monster_id].skill.id){case 30:if(_searchMonsterHavingSkill(31)){aArgs.range_type_id=6;}break;case 31:if(_searchMonsterHavingSkill(30)){aArgs.range_type_id=6;}break;}}switch(aArgs.range_type_id){case 12:var p1=gfu.getXYFromPosId(aArgs.target_pos_id);if(!p1){var mon=gfd.cards[aArgs.target_id];p1=gfu.getXYFromPosId(mon.pos_id);}if(p1.x!=1){return true;}break;case 30:var tmp=gfu.getXYFromPosId(aArgs.target_pos_id);if(!tmp||tmp.y <=1){return false;}if(getGameCardId({pos_category:'field',pos_id:aArgs.target_pos_id})){return false;}else{return true;}break;}if(!aArgs.actor_id){aArgs.actor_id=gfd.actor.game_card_id;}if(aArgs.target_pos_id){aArgs.target_id=getGameCardId({pos_category:'field',pos_id:aArgs.target_pos_id});}var actorMon=gfd.cards[aArgs.actor_id];var targetMon=gfd.cards[aArgs.target_id];switch(aArgs.range_type_id){default:if(aArgs.actor_id==aArgs.target_id){return false;}break;}switch(aArgs.range_type_id){case 12:case 26:case 34:case 35:break;case 23:if(!targetMon.standby_flg){return false;}break;default:if(targetMon.standby_flg!=false){return false;}break;}switch(aArgs.range_type_id){case 0:if(gfu.getDistance(actorMon.pos_id,targetMon.pos_id)==1){return true;}break;case 1:if(gfu.getDistance(actorMon.pos_id,targetMon.pos_id)==2){return true;}break;case 2:if(gfu.getDistance(actorMon.pos_id,targetMon.pos_id)==3){return true;}break;case 3:case 4:var p1=gfu.getXYFromPosId(actorMon.pos_id);var p2=gfu.getXYFromPosId(targetMon.pos_id);var dist=Math.max(Math.abs(p1.x-p2.x),Math.abs(p1.y-p2.y));if(aArgs.range_type_id==3 && 2 < dist){return false;}var p3={x:(p2.x-p1.x)/ dist,y:(p2.y-p1.y)/ dist};for(var i=1;i < dist;i++){var pTmp={x:p3.x,y:p3.y};pTmp.x *=i;pTmp.y *=i;var betweenId=getGameCardId({pos_category:'field',pos_id:gfu.getRelativePosId(actorMon.pos_id,pTmp)});if(betweenId){if(!gfd.cards[betweenId].standby_flg){return false;}}}if(dist <=2||(dist <=3 && aArgs.range_type_id==4)){return true;}break;case 5:case 6:case 10:case 29:return true;break;case 12:case 7:case 11:case 16:case 27:if(gmd.m_card[targetMon.card_id].category=='master'){return false;}return true;break;case 9:if(gfu.getDistance(actorMon.pos_id,targetMon.pos_id)==3){return true;}case 8:var p1=gfu.getXYFromPosId(actorMon.pos_id);var p2=gfu.getXYFromPosId(targetMon.pos_id);var df={x:Math.abs(p1.x-p2.x),y:Math.abs(p1.y-p2.y)};if(Math.min(df.x,df.y)==1 && Math.max(df.x,df.y)==2){return true;}break;case 13:if(gmd.m_card[targetMon.card_id].category=='master'){return false;}if(gfu.getDistance(actorMon.pos_id,targetMon.pos_id)==1){return true;}break;case 14:var dist=gfu.getDistance(actorMon.pos_id,targetMon.pos_id);if(dist==2||dist==3){return true;}break;case 15:if(targetMon.owner=='my' && targetMon.pos_id!='myMaster'){return true;}break;case 17:if(targetMon.owner!='my'||targetMon.pos_id=='myMaster'){return false;}var nMaxAct=1;var aMonsterData=gmd.m_monster[targetMon.monster_id];if(aMonsterData.skill.id==4){nMaxAct=2;}else if(aMonsterData.skill.id==5){nMaxAct=3;}if(targetMon.act_count < nMaxAct){return true;}break;case 18:var p1=gfu.getXYFromPosId(actorMon.pos_id);var p2=gfu.getXYFromPosId(targetMon.pos_id);if(p1.y!=3){return false;}if(p2.y!=1){return false;}if(Math.abs(p2.x-p1.x)<=1){return true;}break;case 19:case 31:var p2=gfu.getXYFromPosId(targetMon.pos_id);if(aArgs.range_type_id==19){var cd=gmd.m_card[targetMon.card_id];if(cd.category=='master'){return false;}}if(p2.y==1||p2.y==2){return true;}break;case 20:var p2=gfu.getXYFromPosId(targetMon.pos_id);if(p2.y==0||p2.y==3){return true;}break;case 22:if(gfu.getDistance(actorMon.pos_id,targetMon.pos_id)!=1){return false;}case 21:var cd=gmd.m_card[targetMon.card_id];if(cd.category=='master'){return true;}break;case 23:var cd=gmd.m_card[targetMon.card_id];if(cd.category!='master'){return true;}break;case 24:var mon=gmd.m_monster[actorMon.monster_id];var p1=gfu.getXYFromPosId(actorMon.pos_id);var p2=gfu.getXYFromPosId(targetMon.pos_id);if(p2.y-p1.y==-1){if(p2.x-p1.x==-1 && mon.skill.id==23){return true;}else if(p2.x-p1.x==1 && mon.skill.id==24){return true;}}break;case 25:if(targetMon.pos_id=='myMaster'){return true;}break;case 26:if(targetMon.pos_category=='hand' && targetMon.owner=='my'){return true;}break;case 28:if(targetMon.card_id==1){return true;}break;case 32:var p1=gfu.getXYFromPosId(actorMon.pos_id);var p2=gfu.getXYFromPosId(targetMon.pos_id);var df={x:p2.x-p1.x,y:p2.y-p1.y};if(df.y==-1){if(df.x==0||df.x==1){return true;}}break;case 33:var p1=gfu.getXYFromPosId(actorMon.pos_id);var p2=gfu.getXYFromPosId(targetMon.pos_id);var df={x:p2.x-p1.x,y:p2.y-p1.y};if(df.y==-1){if(df.x==0||df.x==-1){return true;}}break;case 34:if(targetMon.pos_category!='hand'){return false;}var aCardData=gmd.m_card[targetMon.card_id];if(aCardData.category=='monster_front'||aCardData.category=='monster_back'){return true;}else{return false;}break;case 35:if(targetMon.game_card_id==actorMon.game_card_id){return false;}if(targetMon.owner!=actorMon.owner){return false;}if(targetMon.pos_category=='hand'){return true;}if(typeof targetMon.pos_id!='undefined' && targetMon.pos_id=='myMaster'){return true;}break;}}catch(e){}return false;}function checkGameState(){var sState=(function(){if(gfd.sort_card_flg){return 'sort_card';}if(gfd.tokugi_fuuji_flg){return 'tokugi_fuuji';}if(gfd.end_phase_flg){return 'end_phase';}try{$.each(gfd.cards,function(i,val){if(val.status){if(val.status[111]){return true;}if(val.status[127]){return true;}if(val.status[128]){return true;}}if(0 < val.lvup_standby){throw 'lvup_standby';}if(0 < gfd.lvup_assist){throw 'lvup_standby';}});}catch(e){if(e=='lvup_standby'){return 'lvup_standby';}else{throw e;}}if(gfd.actor.act_type){return 'select_target';}else if(gfd.actor.game_card_id){return 'select_action';}return 'select_actor';})();if(sState!='select_actor'){}return sState;}function updateGameInfoMessage(){var s=checkGameState();if(gfd.standby_game_flg){gfu.myAlertInField({message:'あなたは後攻です。マリガンの確認をして、ターンを終了して下さい',no_alert:true});return;}if(g_sBeforeGameState==s){return;}g_sBeforeGameState=s;switch(s){case 'standby_game':s='あなたは後攻です。マリガンの確認をして、ターンを終了して下さい';break;case 'select_actor':s='カードを選択してください';break;case 'select_action':s='コマンドを選択してください';break;case 'select_target':s='対象を選択してください';break;case 'lvup_standby':s='レベルアップさせるモンスターを選択してください';break;case 'tokugi_fuuji':s='封じる特技を選択してください';break;case 'end_phase':s='不要な手札を捨ててください';break;default:return;}gfu.myAlertInField({message:s,no_alert:true});}};function createArtsQueue(m){var gmd=m;var bNoArrange=0;return{'setNoArrangeFlg':function(f){bNoArrange=f;},'getNoArrangeFlg':function(){return bNoArrange;},'getArtsQueue':getArtsQueue};function getArtsQueue(aArgs){var aQueue=null;try{delete aArgs.field_data.tokugi_fuuji_flg;var mon=aArgs.field_data.cards[aArgs.actor_id];var aArtInfo=gmd.m_arts[aArgs.art_id];var bSealed=(function(){try{if(mon.status[110].param1==aArgs.art_id){gfu.myAlertInField({message:'特技を封じられています！'});return true;}}catch(e){}return false;})();if(bSealed){return null;}aQueue={actor_id:aArgs.actor_id,resolved_flg:0,priority:'command',queue_units:_getQueueUnitsFromScriptId(aArgs)};if(0 < Number(aArtInfo.stone)){var rate=-1;try{if(mon.status[120].param1==aArgs.art_id){rate=-2;}}catch(e){}aQueue.queue_units.unshift({queue_type_id:1004,target_id:aArgs.actor_id,param1:rate * Number(aArtInfo.stone),cost_flg:true});}aQueue.queue_units.unshift({queue_type_id:1002,target_id:aArgs.actor_id,param1:aArgs.art_id,cost_flg:true});aQueue.queue_units.push({queue_type_id:1024,target_id:aArgs.actor_id,cost_flg:true});}catch(e){if(e!='tokugi_fuuji_flg set.'){}return null;}return aQueue;}function _getQueueUnitsFromScriptId(aArgs){var aArtInfo=gmd.m_arts[aArgs.art_id];var _checkTargetEvolOK=function(aMonsterInfo){var b=false;$.each(aArgs.field_data.cards,function(i,val){b=gfu.isValidSuper({aBefore:aMonsterInfo,aAfter:val});if(b){return false;}});return b;};switch(Number(aArtInfo.script_id)){case 1000:return [{queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:aArgs.targets[0].game_card_id,param1:aArtInfo.power},];break;case 1001:var aActor=aArgs.field_data.cards[aArgs.actor_id];var aTarget=aArgs.field_data.cards[aArgs.targets[0].game_card_id];var p1=gfu.getXYFromPosId(aActor.pos_id);var p2=gfu.getXYFromPosId(aTarget.pos_id);var df={x:p2.x-p1.x,y:p2.y-p1.y};for(var i=1;i < 4;i++){if(Math.abs(df.x)% i==0 && Math.abs(df.y)% i==0){df.x /=i;df.y /=i;}}var aRet=[];$.each(aArgs.field_data.cards,function(j,val){if(val.pos_category!='field'){return true;}if(val.next_game_card_id){return true;}if(val.standby_flg){return true;}for(var i=1;i <=3;i++){var p={x:df.x*i,y:df.y*i};if(gfu.getRelativePosId(aActor.pos_id,p)==val.pos_id){aRet.push({queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:val.game_card_id,param1:aArtInfo.power+1-gfu.getDistance(val.pos_id,aActor.pos_id)});}}});if(aRet.length){return aRet;}break;case 1002:var sActorPos=aArgs.field_data.cards[aArgs.actor_id].pos_id;var sTargetPos=aArgs.field_data.cards[aArgs.targets[0].game_card_id].pos_id;var iDist=gfu.getDistance(sActorPos,sTargetPos);return [{queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:aArgs.targets[0].game_card_id,param1:aArtInfo.power+1-iDist},];break;case 1003:return [{queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:aArgs.targets[0].game_card_id,param1:aArtInfo.power},{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:101},];break;case 1004:var aRet=[];var p=gfu.getXYFromPosId(aArgs.field_data.cards[aArgs.targets[0].game_card_id].pos_id);$.each(aArgs.field_data.cards,function(j,val){if(val.pos_category!='field'){return true;}if(val.next_game_card_id){return true;}if(val.standby_flg){return true;}for(var i=0;i < 4;i++){var sPosId=gfu.getPosIdFromXY({x:p.x,y:i});if(val.pos_id==sPosId){aRet.push({queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:val.game_card_id,param1:aArtInfo.power});}}});if(aRet.length > 0){return aRet;}break;case 1005:return [{queue_type_id:1020,target_id:aArgs.targets[0].game_card_id,param1:aArtInfo.power}];break;case 1006:var aMonsterInfo=aArgs.field_data.cards[aArgs.targets[0].game_card_id];var aMonsterData=gmd.m_monster[aMonsterInfo.monster_id];var aRet=[{queue_type_id:1017,target_id:aMonsterInfo.game_card_id,param1:1,param2:true}];if(aMonsterData.next_monster_id||_checkTargetEvolOK(aMonsterInfo)){aRet.push({queue_type_id:1019,target_id:aMonsterInfo.game_card_id});}else{break;}return aRet;break;case 1007:var aRet=[];if(rgn.rand(0,1)){aRet.push({queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:aArgs.targets[0].game_card_id,param1:aArtInfo.power});}else{aRet.push({queue_type_id:9999,target_id:aArgs.actor_id,param1:'suka'});}return aRet;break;case 1008:var aRet=[{queue_type_id:1017,target_id:aArgs.targets[0].game_card_id,param1:1,param2:true},{queue_type_id:1019,target_id:aArgs.targets[0].game_card_id}];var aMonsterInfo=aArgs.field_data.cards[aArgs.targets[0].game_card_id];var aMonsterData=gmd.m_monster[aMonsterInfo.monster_id];if(aMonsterData.next_monster_id){return aRet;}if(_checkTargetEvolOK(aMonsterInfo)){return aRet;}else{return [{queue_type_id:1008,target_id:aArgs.targets[0].game_card_id}];}break;case 1009:return [{queue_type_id:1008,target_id:aArgs.targets[0].game_card_id}];break;case 1010:var aRet=[];var mon=aArgs.field_data.cards[aArgs.targets[0].game_card_id];$.each(gmd.m_status,function(i,val){i=Number(i);if(val.status_type!='P' && val.status_type!='S' && val.status_type!='M'){return true;}if(mon.status){if(mon.status[i]){aRet.push({queue_type_id:1027,target_id:aArgs.targets[0].game_card_id,param1:i});}}});return aRet;break;case 1011:return [{queue_type_id:1007,target_id:aArgs.targets[0].game_card_id,param1:aArtInfo.power}];break;case 1012:var dam=rgn.rand(2,5);return [{queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:aArgs.targets[0].game_card_id,param1:dam},{queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:aArgs.actor_id,param1:dam},];break;case 1013:var aMonsterInfo=aArgs.field_data.cards[aArgs.actor_id];var iMaxHP=gfu.getMaxHP(aMonsterInfo);var dam=iMaxHP-aMonsterInfo.hp;return [{queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:aArgs.targets[0].game_card_id,param1:dam},{queue_type_id:1008,target_id:aArgs.actor_id},];break;case 1014:return [{queue_type_id:1002,target_id:aArgs.actor_id},{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:117,param2:aArgs.actor_id,cost_flg:true},{queue_type_id:1026,target_id:aArgs.actor_id,param1:118,param2:aArgs.targets[0].game_card_id,cost_flg:true},];break;case 1015:var aMonsterInfo=aArgs.field_data.cards[aArgs.actor_id];var iMaxHP=gfu.getMaxHP(aMonsterInfo);var aRet=[{queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:aArgs.targets[0].game_card_id,param1:aArtInfo.power}];if(iMaxHP <=aMonsterInfo.hp){aRet.push({queue_type_id:1008,target_id:aArgs.actor_id});}else{aRet.push({queue_type_id:1007,target_id:aArgs.actor_id,param1:aArtInfo.power});}return aRet;break;case 1016:return [{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:129}];break;case 1017:var aActor=aArgs.field_data.cards[aArgs.actor_id];var aTarget=aArgs.field_data.cards[aArgs.targets[0].game_card_id];var p1=gfu.getXYFromPosId(aActor.pos_id);var p2=gfu.getXYFromPosId(aTarget.pos_id);var sPosMoveTo=gfu.getRelativePosId(aActor.pos_id,{x:0,y:-1});var aRet=[{queue_type_id:1022,target_id:aArgs.actor_id,param1:sPosMoveTo,cost_flg:true}];$.each(aArgs.field_data.cards,function(i,val){if(val.pos_category!='field'){return true;}if(val.next_game_card_id){return true;}if(val.pos_id==sPosMoveTo){aRet.push({queue_type_id:1022,target_id:val.game_card_id,param1:aActor.pos_id,cost_flg:true});}else{if(val.standby_flg){return true;}for(var j=-1;j <=1;j++){var sPosId=gfu.getPosIdFromXY({x:p1.x+j,y:p1.y-2});if(val.pos_id==sPosId){aRet.push({queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:val.game_card_id,param1:aArtInfo.power});break;}}}});return aRet;break;case 1018:var sPosId=(function(){var a=[ 'enemyBack1','enemyBack2','enemyFront1','enemyFront2','enemyMaster',];return a[rgn.rand(0,4)];})();var aRet=[{queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:gfr.getGameCardId({pos_category:'field',pos_id:sPosId}),param1:aArtInfo.power}];$.each(aArgs.field_data.cards,function(i,val){if(val.pos_category!='field'){return true;}if(val.next_game_card_id){return true;}if(val.standby_flg){return true;}if(gfu.getDistance(sPosId,val.pos_id)==1){aRet.push({queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:val.game_card_id,param1:aArtInfo.power-1});}});if(aRet.length){return aRet;}break;case 1019:return [{queue_type_id:1007,target_id:aArgs.actor_id,param1:1},{queue_type_id:1026,target_id:aArgs.actor_id,param1:131},{queue_type_id:1008,target_id:aArgs.targets[0].game_card_id,cost_flg:true},];break;case 1020:var aMonsterInfo=gmd.m_monster[aArgs.field_data.cards[aArgs.targets[0].game_card_id].monster_id];return [{queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:aArgs.targets[0].game_card_id,param1:aMonsterInfo.lv}];break;case 1021:var aRet=[];if(aArgs.targets[0].game_card_id && aArgs.targets[1].pos_id){aRet.push({queue_type_id:1022,target_id:aArgs.targets[0].game_card_id,param1:aArgs.targets[1].pos_id});}if(aArgs.targets[1].game_card_id && aArgs.targets[0].pos_id){aRet.push({queue_type_id:1022,target_id:aArgs.targets[1].game_card_id,param1:aArgs.targets[0].pos_id});}return aRet;break;case 1022:var aRet=[{queue_type_id:1010,target_id:aArgs.targets[0].game_card_id}];if(aArtInfo.damage_type_flg!='O'){aRet.push({queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:aArgs.targets[0].game_card_id,param1:aArtInfo.power});}return aRet;break;case 1023:var aMonsterInfo=aArgs.field_data.cards[aArgs.targets[0].game_card_id];var iStone=2;if(aMonsterInfo.owner=='my'){iStone=Math.min(aArgs.field_data.my_stone,2);}else if(aMonsterInfo.owner=='enemy'){iStone=Math.min(aArgs.field_data.enemy_stone,2);}else{throw new Error('invalid_target');}return [{queue_type_id:1004,target_id:aArgs.targets[0].game_card_id,param1:-1 * iStone},{queue_type_id:1004,target_id:aArgs.actor_id,param1:iStone},];break;case 1024:return [{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:101},];break;case 1025:var iSt=101;if(bNoArrange){iSt=130;}return [{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:iSt},];break;case 1026:var mon=aArgs.field_data.cards[aArgs.actor_id];var p0=gfu.getXYFromPosId(mon.pos_id);var lrCnt=0;var pow=0;var aRet=[];$.each(aArgs.field_data.cards,function(i,val){if(val.pos_category!='field'){return true;}if(val.next_game_card_id){return true;}if(val.standby_flg){return true;}var p=gfu.getXYFromPosId(val.pos_id);if(p.y==p0.y && p.x!=1){var aMonsterData=gmd.m_monster[val.monster_id];if(p.x==0 && Number(aMonsterData.skill.id)!=24){throw new Error('レオンいないのでダメ');}if(p.x==2 && Number(aMonsterData.skill.id)!=23){throw new Error('ラオンいないのでダメ');}lrCnt++;aRet.push({queue_type_id:1027,target_id:val.game_card_id,param1:133,cost_flg:true});if(val.game_card_id!=mon.game_card_id){aRet.push({queue_type_id:1024,target_id:val.game_card_id,cost_flg:true});if(val.status){if(val.status[110]){throw new Error('特技封じ利いてるからダメ');}if(val.status[129]){throw new Error('かなしばり食らってるからダメ');}var bProvoked=gfr.isProvoked({game_card_id:val.game_card_id});if(bProvoked){var iProvokingId=val.status[117].param1;if(iProvokingId!=aArgs.targets[0].game_card_id){throw new Error('挑発利いてるからダメ');}}if(val.status[123]){aRet.push({queue_type_id:1004,target_id:val.game_card_id,param1:-2,cost_flg:true});}}}pow+=gmd.m_monster[val.monster_id].attack.power;}});if(lrCnt < 2){throw new Error('invalid_actor');}aRet.push({queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:aArgs.targets[0].game_card_id,param1:pow,param2:'drill_break'});return aRet;break;case 1027:return [{queue_type_id:1011,target_id:aArgs.targets[0].game_card_id,param1:'draw',param2:parseInt(aArtInfo.power)},];break;case 1028:return [{queue_type_id:1004,target_id:aArgs.targets[0].game_card_id,param1:-1,cost_flg:true},{queue_type_id:1017,target_id:aArgs.actor_id,param1:1,param2:true},{queue_type_id:1019,target_id:aArgs.actor_id}];break;case 1029:return [{queue_type_id:1008,target_id:aArgs.actor_id}];break;case 1030:return [{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:128}];break;case 1031:if(aArgs.param2){return [{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:110,param2:aArgs.param2}];}else{aArgs.field_data.tokugi_fuuji_flg=true;throw 'tokugi_fuuji_flg set.';}break;case 1032:var aActor=aArgs.field_data.cards[aArgs.actor_id];var aRet=[{queue_type_id:1008,target_id:aArgs.actor_id},{queue_type_id:1013,target_id:aArgs.targets[0].game_card_id,param1:aActor.pos_id},{queue_type_id:1010,target_id:aArgs.targets[0].game_card_id},];if(gmd.m_monster[aActor.monster_id].lv==2){aRet.push({queue_type_id:1017,target_id:aArgs.targets[0].game_card_id,param1:1,param2:true});aRet.push({queue_type_id:1019,target_id:aArgs.targets[0].game_card_id});}if(bNoArrange){for(var i=0;i < 3;i++){aRet.push({queue_type_id:1024,target_id:aArgs.targets[0].game_card_id});}}return aRet;break;case 1033:var aTarget=aArgs.field_data.cards[aArgs.targets[0].game_card_id];var aRet=[];try{$.each(aArgs.field_data.cards,function(i,val){if(val.pos_category!='field'){return true;}if(val.next_game_card_id){return true;}if(val.owner!=aTarget.owner){return true;}if(val.status){if(val.status[114]){throw 'kagenui';}}var sPosId='';switch(val.pos_id){case 'myFront1':case 'enemyBack2':sPosId=gfu.getRelativePosId(val.pos_id,{x:2,y:0});break;case 'myFront2':case 'enemyBack1':sPosId=gfu.getRelativePosId(val.pos_id,{x:0,y:1});break;case 'myBack1':case 'enemyFront2':sPosId=gfu.getRelativePosId(val.pos_id,{x:0,y:-1});break;case 'myBack2':case 'enemyFront1':sPosId=gfu.getRelativePosId(val.pos_id,{x:-2,y:0});break;}if(sPosId){aRet.push({queue_type_id:1022,target_id:val.game_card_id,param1:sPosId});}});}catch(e){if(e!='kagenui'){throw e;}aRet=[];}aRet.push({queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:aTarget.game_card_id,param1:aArtInfo.power});return aRet;break;case 1034:return [{queue_type_id:1020,target_id:aArgs.targets[0].game_card_id,param1:1,cost_flg:true},{queue_type_id:1017,target_id:aArgs.targets[1].game_card_id,param1:1},];break;case 1035:return [{queue_type_id:1004,target_id:aArgs.targets[0].game_card_id,param1:aArtInfo.power},];break;case 1036:return [{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:106},];break;case 1037:return [{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:102},];break;case 1038:var aRet=[];var mon=aArgs.field_data.cards[aArgs.targets[0].game_card_id];var p1=gfu.getXYFromPosId(mon.pos_id);$.each(aArgs.field_data.cards,function(i,val){if(val.pos_category!='field'){return true;}if(val.next_game_card_id){return true;}if(val.standby_flg){return true;}var p2=gfu.getXYFromPosId(val.pos_id);if(p2.y==p1.y){aRet.push({queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:val.game_card_id,param1:aArtInfo.power});}});return aRet;break;case 1039:var aRet=[];var mon=aArgs.field_data.cards[aArgs.targets[0].game_card_id];$.each(aArgs.field_data.cards,function(i,val){if(val.pos_category!='field'){return true;}if(val.next_game_card_id){return true;}if(val.standby_flg){return true;}aRet.push({queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:val.game_card_id,param1:aArtInfo.power});});return aRet;break;case 1040:return [{queue_type_id:9999,target_id:aArgs.targets[0].game_card_id,param1:'regenerate'},];break;case 1041:var aRet=[];var sOwner='my';if(rgn.rand(0,1)){sOwner='enemy';}$.each(aArgs.field_data.cards,function(i,val){if(val.pos_category!='field'){return true;}if(val.standby_flg){return true;}if(val.owner!=sOwner){return true;}aRet.push({queue_type_id:(sOwner=='my')? 1007:1006,target_id:val.game_card_id,param1:aArtInfo.power});});return aRet;break;case 1042:return [{queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:aArgs.targets[0].game_card_id,param1:aArtInfo.power},{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:114},{queue_type_id:1026,target_id:aArgs.actor_id,param1:114},];break;case 1043:var aRet=[{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:111}];if(!bNoArrange){if(aArtInfo.damage_type_flg=='P'||aArtInfo.damage_type_flg=='D'){aRet.push({queue_type_id:(aArtInfo.damage_type_flg=='D' ? 1006:1005),target_id:aArgs.targets[0].game_card_id,param1:aArtInfo.power});}}return aRet;break;default:throw new Error('unknown script_id posted.');}throw new Error('_getQueueUnitsFromScriptId Failure.');}};function createMagicQueue(m){var gmd=m;var bNoArrange=0;return{'setNoArrangeFlg':function(f){bNoArrange=f;},'getNoArrangeFlg':function(){return bNoArrange;},'getMagicQueue':getMagicQueue};function getMagicQueue(aArgs){var aQueue=null;try{delete aArgs.field_data.tokugi_fuuji_flg;var iMasterId=null;$.each(aArgs.field_data.cards,function(i,val){if(val.pos_id=='myMaster'){iMasterId=val.game_card_id;return false;}});if(gfr.isProvoked({game_card_id:iMasterId})){throw new Error('Master is provoked.');}var mon=aArgs.field_data.cards[aArgs.actor_id];var aMagicInfo=gmd.m_magic[aArgs.magic_id];aQueue={actor_id:aArgs.actor_id,resolved_flg:0,priority:'command',queue_units:_getQueueUnitsFromMagicId(aArgs)};if(0 < Number(aMagicInfo.stone)){aQueue.queue_units.unshift({queue_type_id:1004,target_id:aArgs.actor_id,param1:-1 * Number(aMagicInfo.stone),cost_flg:true});}aQueue.queue_units.unshift({queue_type_id:1024,target_id:iMasterId,cost_flg:true});aQueue.queue_units.unshift({queue_type_id:1014,target_id:aArgs.actor_id,cost_flg:true});aQueue.queue_units.unshift({queue_type_id:1003,target_id:aArgs.actor_id,cost_flg:true});}catch(e){return null;}return aQueue;}function _getQueueUnitsFromMagicId(aArgs){var aMagicInfo=gmd.m_magic[aArgs.magic_id];var aRet=(function(){var a={250:106,270:104,550:107,590:103,630:113,860:114,880:108,890:109,910:115,940:102,950:116,960:101,1250:124,1290:100,1500:105};if(a[Number(aMagicInfo.magic_id)]){return [{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:a[Number(aMagicInfo.magic_id)]}];}return null;})();if(aRet){return aRet;}switch(Number(aMagicInfo.magic_id)){case 240:return [{queue_type_id:1007,target_id:aArgs.targets[0].game_card_id,param1:2}];break;case 260:return [{queue_type_id:1005,target_id:aArgs.targets[0].game_card_id,param1:1}];break;case 280:aRet=[{queue_type_id:1003,target_id:aArgs.actor_id}];var mon=aArgs.field_data.cards[aArgs.targets[0].game_card_id];var aMonsterData=gmd.m_monster[mon.monster_id];if(aMonsterData.lv==1 && !aMonsterData.next_monster_id){return [{queue_type_id:9999,param1:'invalid_target'}];}if(rgn.rand(0,1)){aRet.push({queue_type_id:1017,target_id:mon.game_card_id,param1:1,param2:true});if(aMonsterData.next_monster_id){aRet.push({queue_type_id:1019,target_id:mon.game_card_id});}}else{aRet.push({queue_type_id:1020,target_id:mon.game_card_id});}return aRet;break;case 290:return [{queue_type_id:1020,target_id:aArgs.targets[0].game_card_id}];break;case 300:return [{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:106},{queue_type_id:1026,target_id:aArgs.targets[1].game_card_id,param1:106}];break;case 310:return [{queue_type_id:1022,target_id:aArgs.targets[0].game_card_id,param1:aArgs.targets[1].pos_id},{queue_type_id:1022,target_id:aArgs.targets[1].game_card_id,param1:aArgs.targets[0].pos_id}];break;case 320:return [{queue_type_id:1005,target_id:aArgs.targets[0].game_card_id,param1:3}];break;case 560:var aRet=[];$.each(aArgs.field_data.cards,function(l,val){if(val.pos_category!='field'){return true;}if(val.standby_flg){return true;}if(val.next_game_card_id){return true;}aRet.push({queue_type_id:1005,target_id:l,param1:1});});return aRet;break;case 570:var aRet=[{queue_type_id:1008,target_id:aArgs.targets[0].game_card_id}];if(!bNoArrange){aRet.push({queue_type_id:1004,target_id:aArgs.actor_id,param1:1});}return aRet;break;case 580:if(aArgs.param2){return [{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:110,param2:aArgs.param2}];}else{aArgs.field_data.tokugi_fuuji_flg=true;return null;}break;case 600:var aRet=[{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:111}];if(!bNoArrange){aRet.push({queue_type_id:1026,target_id:aArgs.targets[1].game_card_id,param1:111});}return aRet;break;case 610:if(!aArgs.targets[1].game_card_id){break;}var aRet=[{queue_type_id:1008,target_id:aArgs.targets[0].game_card_id}];if(rgn.rand(0,1)){aRet.push({queue_type_id:1008,target_id:aArgs.targets[1].game_card_id});}return aRet;break;case 620:var aRet=[{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:112}];if(bNoArrange){var mon=aArgs.field_data.cards[aArgs.targets[0].game_card_id];var nMaxAct=gfu.getMaxActCount(mon.monster_id);for(var i=0;i < nMaxAct;i++){aRet.unshift({queue_type_id:1024,target_id:mon.game_card_id,cost_flg:true});}}return aRet;break;case 640:var aRet=[];$.each(aArgs.field_data.cards,function(l,val){if(val.pos_category!='field'){return true;}if(val.standby_flg){return true;}if(val.next_game_card_id){return true;}if(!val.status){return true;}$.each(val.status,function(iSt,vSt){switch(gmd.m_status[iSt].status_type){case 'P':case 'S':case 'M':break;default:return true;}aRet.push({queue_type_id:1027,target_id:l,param1:iSt});});});return aRet;break;case 650:var mon=aArgs.field_data.cards[aArgs.targets[0].game_card_id];var aRet=[{queue_type_id:1009,target_id:aArgs.targets[0].game_card_id},{queue_type_id:1013,target_id:aArgs.targets[1].game_card_id,param1:mon.pos_id},{queue_type_id:1010,target_id:aArgs.targets[1].game_card_id}];if(bNoArrange){for(var i=0;i < 3;i++){aRet.push({queue_type_id:1024,target_id:aArgs.targets[1].game_card_id});}}return aRet;break;case 870:var mon=aArgs.field_data.cards[aArgs.targets[0].game_card_id];var aRet=[];$.each(aArgs.field_data.cards,function(l,val){if(val.owner!=mon.owner){return true;}if(val.pos_category!='field'){return true;}if(val.standby_flg){return true;}if(val.next_game_card_id){return true;}if(!val.status){return true;}$.each(val.status,function(iSt,vSt){if(gmd.m_status[iSt].status_type!='M'){return true;}aRet.push({queue_type_id:1027,target_id:l,param1:iSt});});});return aRet;break;case 900:var aRet=[];var mon=aArgs.field_data.cards[aArgs.targets[0].game_card_id];var aUsedCards=[];$.each(aArgs.field_data.cards,function(l,val){if(val.owner!=mon.owner){return true;}if(val.pos_category!='used'){return true;}switch(gmd.m_card[val.card_id].category){case 'monster_front':case 'monster_back':break;default:return true;}aUsedCards.push(l);});if(bNoArrange){aRet.push({queue_type_id:1031,target_id:aUsedCards[rgn.rand()%aUsedCards.length],param1:'first'});}else{for(var i=0;i < 2;i++){var j=rgn.rand()% aUsedCards.length;aRet.push({queue_type_id:1015,target_id:aUsedCards[j]});aUsedCards.splice(j,1);}}return aRet;break;case 920:var aRet=[{queue_type_id:1005,target_id:aArgs.targets[0].game_card_id,param1:2}];if(rgn.rand(0,1)){var p1=gfu.getXYFromPosId(aArgs.targets[0].pos_id);$.each(aArgs.field_data.cards,function(l,val){if(val.pos_category!='field'){return true;}if(val.standby_flg){return true;}if(val.next_game_card_id){return true;}var p2=gfu.getXYFromPosId(val.pos_id);if(Math.abs(p2.x-p1.x)+Math.abs(p2.y-p1.y)==1){aRet.push({queue_type_id:1005,target_id:l,param1:2});}});}return aRet;break;case 930:var aRet=[];$.each(aArgs.field_data.cards,function(i,val){if(val.pos_category!='field'){return true;}if(val.next_game_card_id){return true;}if(val.status){if(val.status[114]){throw new Error('kagenui');}}var sPosId='';if(Number(aArgs.param1)==1){switch(val.pos_id){case 'myFront1':case 'enemyBack2':sPosId=gfu.getRelativePosId(val.pos_id,{x:2,y:0});break;case 'myFront2':case 'enemyBack1':sPosId=gfu.getRelativePosId(val.pos_id,{x:0,y:1});break;case 'myBack1':case 'enemyFront2':sPosId=gfu.getRelativePosId(val.pos_id,{x:0,y:-1});break;case 'myBack2':case 'enemyFront1':sPosId=gfu.getRelativePosId(val.pos_id,{x:-2,y:0});break;}}else{switch(val.pos_id){case 'myFront1':case 'enemyBack2':sPosId=gfu.getRelativePosId(val.pos_id,{x:0,y:1});break;case 'myFront2':case 'enemyBack1':sPosId=gfu.getRelativePosId(val.pos_id,{x:-2,y:0});break;case 'myBack1':case 'enemyFront2':sPosId=gfu.getRelativePosId(val.pos_id,{x:2,y:0});break;case 'myBack2':case 'enemyFront1':sPosId=gfu.getRelativePosId(val.pos_id,{x:0,y:-1});break;}}if(sPosId){aRet.push({queue_type_id:1022,target_id:val.game_card_id,param1:sPosId});}});return aRet;break;case 970:return [{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:118,param2:aArgs.targets[1].game_card_id},{queue_type_id:1026,target_id:aArgs.targets[1].game_card_id,param1:117,param2:aArgs.targets[0].game_card_id}];break;case 980:return [{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:119,param2:aArgs.targets[1].game_card_id},{queue_type_id:1026,target_id:aArgs.targets[1].game_card_id,param1:119,param2:aArgs.targets[0].game_card_id}];break;case 1130:if(bNoArrange){return [{queue_type_id:1004,target_id:aArgs.targets[0].game_card_id,param1:'harf'}];}return [{queue_type_id:1006,target_id:aArgs.targets[0].game_card_id,param1:3}];break;case 1140:var mon=aArgs.field_data.cards[aArgs.targets[0].game_card_id];var aRet=[];var aGameCardId=[];var iHands=0;if(!bNoArrange){return [{queue_type_id:1011,target_id:mon.game_card_id,param1:'draw',param2:2},{queue_type_id:1026,target_id:mon.game_card_id,param1:132}];}$.each(aArgs.field_data.cards,function(l,val){if(val.owner==mon.owner){if(val.pos_category=='hand'){iHands++;aRet.push({queue_type_id:1031,target_id:l,cost_flg:true});aGameCardId.push(l);}else if(val.pos_category=='deck'){aGameCardId.push(l);}}});aGameCardId.sort(function(){return rgn.rand(0,1)-0.5;});var iSortNo=1000;$.each(aGameCardId,function(k,l){aRet.push({queue_type_id:1012,target_id:l,param1:iSortNo++});});aRet.push({queue_type_id:1011,target_id:mon.game_card_id,param1:'draw',param2:iHands});return aRet;break;case 1150:return [{queue_type_id:9999,target_id:aArgs.targets[0].game_card_id,param1:'sort_card'}];break;case 1160:var aRet=[];var iDraw=0;for(var i=0;i < aArgs.targets.length;i++){if(typeof aArgs.targets[i].pos_id!='undefined' && aArgs.targets[i].pos_id=='myMaster'){aRet.push({queue_type_id:1011,target_id:aArgs.targets[i].game_card_id,param1:'draw',param2:iDraw});return aRet;}aRet.push({queue_type_id:1014,target_id:aArgs.targets[i].game_card_id});iDraw++;}break;case 1170:return [{queue_type_id:1010,target_id:aArgs.targets[0].game_card_id}];break;case 1180:var aRet=[];var p1=gfu.getXYFromPosId(aArgs.field_data.cards[aArgs.targets[0].game_card_id].pos_id);$.each(aArgs.field_data.cards,function(l,val){if(val.pos_category!='field'){return true;}if(val.next_game_card_id){return true;}if(val.standby_flg){return true;}var p2=gfu.getXYFromPosId(val.pos_id);if(p2.y==p1.y){aRet.push({queue_type_id:1005,target_id:l,param1:1});}});return aRet;break;case 1190:if(aArgs.param2){return [{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:120,param2:aArgs.param2}];}else{aArgs.field_data.tokugi_fuuji_flg=true;return null;}break;case 1200:var aRet=[];var mon=aArgs.field_data.cards[aArgs.targets[0].game_card_id];var nHand=0;$.each(aArgs.field_data.cards,function(l,val){if(val.game_card_id==aArgs.actor_id){return true;}if(val.owner==mon.owner && val.pos_category=='hand'){nHand++;}});if(nHand < 5){aRet=[{queue_type_id:1011,target_id:mon.game_card_id,param1:'draw',param2:5-nHand}];if(!bNoArrange){aRet.push({queue_type_id:1004,target_id:mon.game_card_id,param1:nHand-5,cost_flg:true});}return aRet;}break;case 1210:var iMin=2;if(bNoArrange){iMin=1;}return [{queue_type_id:1004,target_id:aArgs.targets[0].game_card_id,param1:rgn.rand(iMin,3)}];break;case 1220:return [{queue_type_id:1008,target_id:aArgs.targets[0].game_card_id}];break;case 1230:var mon=aArgs.field_data.cards[aArgs.targets[0].game_card_id];var aValidTargets=[];$.each(aArgs.field_data.cards,function(l,val){if(val.owner!=mon.owner){return true;}if(val.pos_category!='deck'){return true;}var d=gmd.m_card[val.card_id];switch(aArgs.param1){case 'front':if(d.category!='monster_front'){return true;}break;case 'back':if(d.category!='monster_back'){return true;}break;case 'magic':if(d.category!='magic'){return true;}break;case 'super':if(d.category!='super_front' && d.category!='super_back'){return true;}break;default:throw new Error('invalid_param');break;}aValidTargets.push(l);});if(aValidTargets.length <=0){return [{queue_type_id:1003}];}return [{queue_type_id:1011,target_id:aValidTargets[rgn.rand(0,aValidTargets.length-1)]}];break;case 1240:var aRet=[];var aMst=[];aMst.push(gfr.getGameCardId({pos_category:'field',pos_id:'myMaster'}));aMst.push(gfr.getGameCardId({pos_category:'field',pos_id:'enemyMaster'}));for(var i=0;i < 2;i++){var mon=aArgs.field_data.cards[aMst[i]];if(!mon.status){continue;}$.each(mon.status,function(iSt,vSt){aRet.push({queue_type_id:1027,target_id:mon.game_card_id,param1:iSt});});}aRet.push({queue_type_id:1026,target_id:aMst[0],param1:121,param2:aArgs.field_data.cards[aMst[1]].monster_id});aRet.push({queue_type_id:1026,target_id:aMst[1],param1:121,param2:aArgs.field_data.cards[aMst[0]].monster_id});return aRet;break;case 1260:var aRet=[];$.each(aArgs.field_data.cards,function(i,val){if(val.pos_category!='field'){return true;}if(val.next_game_card_id){return true;}if(val.standby_flg){return true;}aRet.push({queue_type_id:1005,target_id:val.game_card_id,param1:3});});return aRet;break;case 1270:return [{queue_type_id:1007,target_id:aArgs.targets[0].game_card_id,param1:1}];break;case 1280:var mon=aArgs.field_data.cards[aArgs.targets[0].game_card_id];var iMasterId=null;$.each(aArgs.field_data.cards,function(l,val){if(val.owner!=mon.owner){return true;}if(gmd.m_card[val.card_id].category=='master'){iMasterId=l;return false;}});return [{queue_type_id:1026,target_id:iMasterId,param1:125,param2:aArgs.targets[0].game_card_id},{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:126,param2:iMasterId}];break;case 1300:return [{queue_type_id:9999,target_id:aArgs.targets[0].game_card_id,param1:'regenerate'}];break;case 1480:var mon0=aArgs.field_data.cards[aArgs.targets[0].game_card_id];var mon1=aArgs.field_data.cards[aArgs.targets[1].game_card_id];if(mon0.owner==mon1.owner){throw new Error('invalid_target');}if(!bNoArrange){if(aArgs.master_data.m_monster[mon0.monster_id].lv!=aArgs.master_data.m_monster[mon1.monster_id].lv){throw new Error('invalid_target');}}return [{queue_type_id:1026,target_id:aArgs.targets[0].game_card_id,param1:127,param2:aArgs.field_data.cards[aArgs.targets[1].game_card_id].monster_id}];break;case 1490:var aRet=[{queue_type_id:1017,target_id:aArgs.targets[0].game_card_id,param1:1,param2:true}];var mon=aArgs.field_data.cards[aArgs.targets[0].game_card_id];if(gmd.m_monster[mon.monster_id].next_monster_id){aRet.push({queue_type_id:1019,target_id:aArgs.targets[0].game_card_id});}return aRet;break;default:throw new Error('unknown magic_id posted.');}throw new Error('_getQueueUnitsFromMagicId Failure.');}};var gfr=null;var gfu=null;var arts_queue=null;var magic_queue=null;new function(){var gmd=null;var iHandMax=5;var gfd={turn:null,my_stone:0,enemy_stone:0,no_arrange:0,lvup_assist:0,tokugi_fuuji_flg:false,sort_card_flg:false,sorting_cards:[],already_finished:false,now_finished:false,pause_flg:false,pause_on_push:false,pause_off_push:false,cards:{},queues:[],old_queues:[],resolved_queues:[],actor:{game_card_id:null},animation_info:{bAnimationProcessing:false,animations:[]}};var g_backup_field_data=null;var g_base_color={background:'#fff'};$(function(){_preload();initSpecialProc();$('#game_field_wrapper').on('click','#game_field td.monster_space',function(){var _updateActorInfo=function(){var l=gfr.getGameCardId({pos_category:'field',pos_id:oDom.attr('id')});gfd.actor={game_card_id:l};$('.actor').removeClass('actor');oDom.addClass('actor');gfr.updateActorDom({field_data:gfd,game_state:sGameState});};var oDom=$(this);var sGameState=gfr.checkGameState();var sActorAutoChange=$('[name=actor_auto_change]:checked').val();if(!sActorAutoChange){sActorAutoChange='hand';}switch(sGameState){case 'select_actor':case 'select_action':case 'lvup_standby':case 'end_phase':_updateActorInfo();break;case 'select_target':try{var sActorPos=gfd.cards[gfd.actor.game_card_id].pos_category;}catch(e){sActorPos='unknown';}var bRange=addTarget({oDom:oDom});if(bRange){}else if(sActorAutoChange==sActorPos||sActorAutoChange=='all'){_updateActorInfo();}break;}});$('#game_field_wrapper').on('click','#hand_card div.hand_card',function(){var _updateActorInfo=function(){gfd.actor={game_card_id:oDom.attr('game_card_id')};$('.actor').removeClass('actor');oDom.addClass('actor');gfr.updateActorDom({field_data:gfd});};var oDom=$(this);switch(gfr.checkGameState()){case 'select_actor':case 'select_action':case 'select_target':var sActorAutoChange=$('[name=actor_auto_change]:checked').val();if(!sActorAutoChange){sActorAutoChange='hand';}try{var sActorPos=gfd.cards[gfd.actor.game_card_id].pos_category;}catch(e){sActorPos='unknown';}if(!gfd.actor.act_type){_updateActorInfo();}else{var bRange=addTarget({oDom:oDom});if(bRange){}else if(sActorAutoChange==sActorPos||sActorAutoChange=='all'){_updateActorInfo();}}break;case 'lvup_standby':try{if(gfd.actor.act_type!='lvup'){break;}}catch(e){break;}var ret=gfu.isValidSuper({aBefore:gfd.cards[gfd.actor.game_card_id],aAfter:gfd.cards[oDom.attr('game_card_id')],check_lvup_standby:true,lvup_assist:gfd.lvup_assist});if(ret){var aQueue={actor_id:null,resolved_flg:0,priority:'system',queue_units:[{queue_type_id:1019,target_id:gfd.actor.game_card_id,param1:oDom.attr('game_card_id')},]};if(!gfd.lvup_magic_flg){aQueue.queue_units.unshift({queue_type_id:1004,target_id:gfd.actor.game_card_id,param1:-1,cost_flg:true});}gfd.queues.push(aQueue);gfd.actor={game_card_id:null};execQueue({resolve_all:true});}break;case 'end_phase':var l=oDom.attr('game_card_id');var sCardName=gmd.m_card[gfd.cards[l].card_id].card_name;if(confirm(sCardName+'を捨てますか？')){gfd.queues.push({actor_id:l,log_message:'手札調整',resolved_flg:0,priority:'system',queue_units:[{queue_type_id:1014,target_id:l}]});var iHands=0;$.each(gfd.cards,function(l,val){if(val.pos_category=='hand' && val.owner=='my'){iHands++;}});if(iHands <=iHandMax+1){$('#hand_card').css('backgroundColor',g_base_color.background);turnEndProc({ignore_hand_num:true});}execQueue({resolve_all:true});}break;}});$('#game_field_wrapper').on('click','.command_row',function(){var oDom=$(this);var aCard=gfd.cards[gfd.actor.game_card_id];switch(gfr.checkGameState()){case 'lvup_standby':case 'select_action':case 'select_target':if(aCard.owner=='enemy' && oDom.attr('act_type')!='lvup'){return;}switch(aCard.pos_category){case 'field':if(aCard.standby_flg){return;}gfd.actor.act_type=oDom.attr('act_type');gfd.actor.art_id=oDom.attr('art_id');gfd.actor.magic_id=oDom.attr('magic_id');var prm1=oDom.attr('param1');if(typeof prm1!=='undefined'){gfd.actor.param1=prm1;}if(gfd.actor.act_type=='lvup'){var aCardData=gmd.m_monster[aCard.monster_id];if(aCardData.next_monster_id){addTarget({oDom:oDom});}}break;case 'hand':gfd.actor.act_type=oDom.attr('act_type');if(gfd.actor.act_type=='magic'){var mid=gmd.m_card[aCard.card_id];if(mid.magic_id){gfd.actor.magic_id=mid.magic_id;}}var prm1=oDom.attr('param1');if(typeof prm1!=='undefined'){gfd.actor.param1=prm1;}break;}$('.command_row').removeClass('selected_act');oDom.addClass('selected_act');break;case 'tokugi_fuuji':var aQueue={};if(gfd.actor.art_id){aQueue=arts_queue.getArtsQueue({field_data:gfd,art_id:gfd.actor.art_id,actor_id:gfd.actor.game_card_id,targets:gfd.actor.aTargets,param2:oDom.attr('art_id')});}else{aQueue=magic_queue.getMagicQueue({field_data:gfd,magic_id:gfd.actor.magic_id,actor_id:gfd.actor.game_card_id,param1:gfd.actor.param1,param2:oDom.attr('art_id'),targets:gfd.actor.aTargets});}if(aQueue){gfd.queues.push(aQueue);execQueue({resolve_all:true});}break;}gfr.updateGameInfoMessage();});$('#game_field_wrapper').on('click','.check_magic_effect[game_card_id]',function(){try{var aCard=gfd.cards[Number($(this).attr('game_card_id'))];if(aCard.status){var sMessage=gmd.m_card[aCard.card_id].card_name+"は以下の効果を受けています\n";$.each(aCard.status,function(iSt,aSt){switch(gmd.m_status[iSt].status_type){case 'P':case 'S':case 'M':sMessage+="\n《"+gmd.m_status[iSt].status_name+'》';sMessage+="\n　"+gmd.m_status[iSt].status_caption;break;}});alert(sMessage);}}catch(e){}gfr.updateGameInfoMessage();});$('#game_field_wrapper').on('click','#buttons_frame div.cancel_button',function(){var _delActorInfo=function(){gfd.actor={game_card_id:null};$('.actor').removeClass('actor');$('.target').removeClass('target');gfr.updateActorDom({field_data:gfd});};switch(gfr.checkGameState()){case 'tokugi_fuuji':delete gfd.tokugi_fuuji_flg;_delActorInfo();break;case 'select_action':case 'select_target':case 'end_phase':_delActorInfo();break;case 'lvup_standby':if(gfd.actor.game_card_id){gfd.actor={game_card_id:null};$('.actor').removeClass('actor');}else if(confirm('レベルアップしなくても良いですか？')){(function(){gfd.queues.push({actor_id:null,log_message:'',resolved_flg:0,priority:'same_time',queue_units:[{queue_type_id:1018}]});$('.lvup_ok').removeClass('lvup_ok');$('.lvup_checking').removeClass('lvup_checking');execQueue({resolve_all:true});})();}gfr.updateActorDom({field_data:gfd});break;}gfr.updateGameInfoMessage();});$('#game_field_wrapper').on('click','#buttons_frame div.turn_end_button',function(){if(gfd.already_finished){alert('決着がついているので、ターンエンドはできません。');}else if(gfr.checkGameState()=='sort_card'){}else if(0 < gfd.old_queues.length){}else{if(confirm("ターンエンドしてもよろしいですか？")){turnEndProc();}}});$('#game_field_wrapper').on('click','.check_used',function(){$('.used_cards_div').toggle();});$('#movie_controll .pause').on('click',function(e){gfd.pause_on_push=1;});$('#movie_controll .play').on('click',function(e){if(gfd.pause_flg){gfd.pause_off_push=1;execQueue({resolve_all:true});}});$('#movie_controll .toggle_log').on('click',function(e){$('#log_list').toggleClass('show_all');if($('#log_list').hasClass('show_all')){$('#movie_controll .toggle_log').val('旧ログ非表示');}else{$('#movie_controll .toggle_log').val('全ログ表示');}});});function _preload(){(function(){var df=$.Deferred();var _version=1.1;try{if(sessionStorage.oMasterData){var d=JSON.parse(sessionStorage.oMasterData);if(d.version!=_version){throw 'gmd is invalid.';}df.resolve(d);}else{throw 'gmd is not yet loaded.';}}catch(e){gmd=null;sessionStorage.oMasterData=null;$.getJSON('/api/get-master-data/card/',function(json){try{json.version=_version;sessionStorage.oMasterData=JSON.stringify(json);df.resolve(json);}catch(e){df.reject();}});}return df.promise();})().done(function(json){gmd=json;arts_queue=createArtsQueue(gmd);magic_queue=createMagicQueue(gmd);gfu=createGameFieldUtility(gmd);gfr=createGameFieldReactions(gmd);initSetting();initField();setTimeout(function(){execQueue({resolve_all:true});},333);}).fail(function(){alert('ゲーム情報の読み込みに失敗しました。\nページを更新して下さい。');});}function initField(){gfr.initMasterData({field_data:gfd,master_data:gmd,base_color:g_base_color});var iGameFieldScrollPos=$('#game_infomation_frame').offset().top;$('html,body').animate({scrollTop:iGameFieldScrollPos},200,'swing');gfd.no_arrange=Number($('div[no_arrange]').attr('no_arrange'));gfd.game_field_id=Number($('input[name=game_field_id]').val());gfd.turn=Number($('div[turn_num]').attr('turn_num'));gfd.my_stone=Number($('#myPlayersInfo div.stone span').text());gfd.enemy_stone=Number($('#enemyPlayersInfo div.stone span').text());gfd.replay_flg=Number($('div[replay_flg]').attr('replay_flg'));rgn.srand(gfd.game_field_id,100);gfd.cards=getCardsJson();gfd.old_queues=getQueueJson();$.each(gfd.cards,function(l,val){if(val.next_game_card_id){gfd.cards[val.next_game_card_id].before_game_card_id=l;}if(val.status){if(val.status.length <=0){val.status={};}}});gfd.old_queues.push({actor_id:null,log_message:'',resolved_flg:0,priority:'system',queue_units:[{queue_type_id:1018}]});gfd.old_queues.push({actor_id:null,log_message:'',resolved_flg:0,priority:'system',queue_units:[{queue_type_id:9999,param1:'game_end_check'}]});gfd.old_queues.push({actor_id:null,log_message:'ターン終了',resolved_flg:0,priority:'system',queue_units:[{queue_type_id:9999,param1:'old_turn_end',param2:true}]});gfr.updateField({field_data:gfd});}function initSetting(){var aRadioSettings=[ 'animation_speed','old_animation_speed','actor_auto_change','alert_popup',];try{var stor=localStorage.game_settings;if(typeof stor=='undefined'){stor='{}';localStorage.setItem('game_settings',stor);}var param=JSON.parse(stor);$.each(aRadioSettings,function(i,val){$('[name='+val+']').val([param[val]]);});}catch(e){}arts_queue.setNoArrangeFlg(gfd.no_arrange);magic_queue.setNoArrangeFlg(gfd.no_arrange);$('#game_field_wrapper').on('click','input.toggle_setting',function(){$('div.settings').toggle();$('input.disp_button').toggle();});$.each(aRadioSettings,function(i,val){$('#game_field_wrapper').on('change','input[name='+val+']',function(){try{var param=JSON.parse(localStorage.game_settings);param[val]=$('input[name='+val+']:checked').val();localStorage.setItem('game_settings',JSON.stringify(param));}catch(e){}});});}function startingProc(aArgs){var myMasterId=gfr.getGameCardId({pos_category:'field',pos_id:'myMaster'});var bInitial=(function(){try{if(gfd.my_stone!=0||gfd.enemy_stone!=0){throw 'not_initial';}var iInitialDeckCards=60;var iDeckCards=0;$.each(gfd.cards,function(l,val){switch(val.pos_category){case 'deck':iDeckCards++;break;case 'hand':case 'used':throw 'not_initial';break;case 'field':if(val.pos_id!='myMaster' && val.pos_id!='enemyMaster'){throw 'not_initial';}break;}});if(iInitialDeckCards <=iDeckCards){return true;}}catch(e){}return false;})();if(bInitial){gfd.standby_game_flg=true;var enemyMasterId=gfr.getGameCardId({pos_category:'field',pos_id:'enemyMaster'});var iEnemyFirstHand=4;if(gfd.no_arrange){iEnemyFirstHand=5;}gfd.queues.push({actor_id:enemyMasterId,log_message:'初期手札をドロー',resolved_flg:0,priority:'system',queue_units:[{queue_type_id:1011,target_id:enemyMasterId,param1:'draw',param2:iEnemyFirstHand},{queue_type_id:1026,target_id:enemyMasterId,param1:132}]});gfd.queues.push({actor_id:myMasterId,log_message:'初期手札をドロー',resolved_flg:0,priority:'system',queue_units:[{queue_type_id:1011,target_id:myMasterId,param1:'draw',param2:5},{queue_type_id:1026,target_id:myMasterId,param1:132}]});}else{gfd.queues.push({actor_id:null,log_message:'ストーン3個を支給',resolved_flg:0,priority:'standby_system',queue_units:[{queue_type_id:1004,target_id:myMasterId,param1:3}]});gfd.queues.push({actor_id:null,log_message:'カードを1枚ドロー',resolved_flg:0,priority:'standby_system',queue_units:[{queue_type_id:1011,target_id:myMasterId,param1:'draw',param2:1}]});}var keys=[ 'enemyMaster','myMaster','myFront1','myFront2','myBack1','myBack2' ];for(var i=0;i < keys.length;i++){var l=gfr.getGameCardId({pos_category:'field',pos_id:keys[i]});var mon=gfd.cards[l];if(mon && !isNaN(mon.card_id)){var aMonsterData=gmd.m_monster[mon.monster_id];var aQueue={actor_id:l,log_message:gfu.getPosCodeFromPosId(mon.pos_id)+aMonsterData.name+'の行動回数をリセット',resolved_flg:0,priority:'standby_system',actor_anime_disable:true,queue_units:[{queue_type_id:1030,target_id:l}]};if(mon.standby_flg){aQueue.log_message=gfu.getPosCodeFromPosId(mon.pos_id)+aMonsterData.name+'登場';aQueue.queue_units[0].queue_type_id=1010;aQueue.actor_anime_disable=false;}gfd.queues.push(aQueue);}}$.each(gfd.cards,function(l,val){if(val.pos_category=='field'){if(val.pos_id=='myBack1'||val.pos_id=='myBack2'){gfd.queues.push({actor_id:l,log_message:gmd.m_monster[val.monster_id].name+'が前進',resolved_flg:0,priority:'standby_system',queue_units:[{queue_type_id:1022,target_id:l,param2:'front_slide'}]});}var aMonsterData=gmd.m_monster[val.monster_id];switch(aMonsterData.skill.id){case 26:if(gfd.no_arrange && val.owner=='my' && !val.standby_flg){gfd.queues.push({actor_id:l,log_message:'きまぐれ発動',resolved_flg:0,priority:'reaction',queue_units:[{queue_type_id:1026,target_id:l,param1:rgn.rand(0,1)? 101:104}]});}else if(val.owner=='enemy' && !val.standby_flg){gfd.queues.push({actor_id:l,log_message:'きまぐれ発動',resolved_flg:0,priority:'reaction',queue_units:[{queue_type_id:1026,target_id:l,param1:rgn.rand(0,1)? 100:104}]});}break;}}});}function initSpecialProc(){$('#game_field_wrapper').on('click','.sort_card_target',function(){try{var iRef=parseInt($(this).closest('[iref]').attr('iref'));var iSortNo=gfd.sorting_cards[iRef].sort_no;var bResolved=false;$.each(gfd.sorting_cards,function(i,val){if(val.bSelected){gfd.sorting_cards[iRef].sort_no=val.sort_no;val.sort_no=iSortNo;delete val.bSelected;bResolved=true;return false;}});if(!bResolved){gfd.sorting_cards[iRef].bSelected=true;}}catch(e){}gfr.updateField({field_data:gfd});});$('#game_field_wrapper').on('click','.sort_end_button',function(){if(confirm('よろしいですか？')){var iMasterId=gfr.getGameCardId({pos_category:'field',pos_id:'myMaster'});var aQueue={actor_id:iMasterId,log_message:'ソートカードを発動',resolved_flg:0,priority:'command',queue_units:[]};$.each(gfd.sorting_cards,function(i,val){aQueue.queue_units.push({queue_type_id:1012,target_id:val.game_card_id,param1:val.sort_no});});if(!gfd.no_arrange){aQueue.queue_units.push({queue_type_id:1004,target_id:iMasterId,param1:1});}gfd.queues.push(aQueue);gfd.sort_card_flg=false;gfd.sorting_cards=[];execQueue({resolve_all:true});}});}function addTarget(aArgs){if(gfd.replay_flg){return false;}var bRangeOk=false;var _addActionFromActorInfo=function(){var actor=gfd.actor;var aQueue=null;var _addStoneNoroiCost=function(mon){try{if(mon.status && mon.status[123]){aQueue.queue_units.unshift({queue_type_id:1004,target_id:mon.game_card_id,param1:-2,cost_flg:true});}}catch(e){}};var _updateFieldToSelectTargetArts=function(){if(gfd.tokugi_fuuji_flg){try{gfr.updateActorDom({field_data:gfd,game_state:'tokugi_fuuji'});var sPosId='#'+gfd.cards[actor.aTargets[0].game_card_id].pos_id;$(sPosId).addClass('selected');}catch(e){}}};switch(actor.act_type){case 'into_field':if(!actor.game_card_id||!actor.param1){throw new Error('actor_info_invalid');}var iMasterId=gfr.getGameCardId({pos_category:'field',pos_id:'myMaster'});aQueue={actor_id:actor.game_card_id,log_message:'モンスターをセット',resolved_flg:0,priority:'command',queue_units:[{queue_type_id:1004,target_id:actor.game_card_id,param1:-1,cost_flg:true},{queue_type_id:1013,target_id:actor.game_card_id,param1:actor.param1},{queue_type_id:1024,target_id:iMasterId,cost_flg:true},]};_addStoneNoroiCost(gfd.cards[iMasterId]);break;case 'attack':var mon=gfd.cards[actor.game_card_id];aQueue={actor_id:actor.game_card_id,log_message:'通常攻撃',resolved_flg:0,priority:'command',queue_units:(function(){var q=[];try{var aCardData=gmd.m_card[mon.card_id];var aMonsterData=gmd.m_monster[mon.monster_id];if(aCardData.category=='master'){q.push({queue_type_id:1004,target_id:actor.game_card_id,param1:-3,cost_flg:true});}else if(aMonsterData.skill.id==13){var target=gfd.cards[actor.aTargets[0].game_card_id];$.each(target.status,function(iSt,aSt){switch(gmd.m_status[iSt].status_type){case 'P':case 'S':case 'M':q.push({queue_type_id:1027,target_id:target.game_card_id,param1:iSt});break;}});}}catch(e){}q.push({queue_type_id:1024,target_id:actor.game_card_id,cost_flg:true},{queue_type_id:1001,target_id:actor.aTargets[0].game_card_id});return q;})()};_addStoneNoroiCost(mon);break;case 'arts':aQueue=arts_queue.getArtsQueue({field_data:gfd,master_data:gmd,art_id:actor.art_id,actor_id:actor.game_card_id,targets:actor.aTargets});_updateFieldToSelectTargetArts();aQueue.log_message=(function(){try{var sName=gmd.m_arts[actor.art_id].name;return sName+'を発動';}catch(e){}return '';})();_addStoneNoroiCost(gfd.cards[aQueue.actor_id]);break;case 'magic':aQueue=magic_queue.getMagicQueue({field_data:gfd,master_data:gmd,magic_id:actor.magic_id,actor_id:actor.game_card_id,param1:actor.param1,targets:actor.aTargets});_updateFieldToSelectTargetArts();aQueue.log_message=(function(){try{var sName=gmd.m_card[gmd.m_magic[actor.magic_id].card_id].card_name;return sName+'を使用';}catch(e){}return '';})();var iMasterId=gfr.getGameCardId({pos_category:'field',pos_id:'myMaster'});_addStoneNoroiCost(gfd.cards[iMasterId]);break;case 'move':aQueue={actor_id:actor.game_card_id,log_message:'移動',resolved_flg:0,priority:'command',queue_units:[{queue_type_id:1024,target_id:actor.game_card_id,cost_flg:true},{queue_type_id:1022,target_id:actor.game_card_id,param1:actor.param1},]};_addStoneNoroiCost(gfd.cards[aQueue.actor_id]);var iPurpose=gfr.getGameCardId({pos_category:'field',pos_id:actor.param1});if(iPurpose){aQueue.queue_units.push({queue_type_id:1024,target_id:iPurpose,cost_flg:true});aQueue.queue_units.push({queue_type_id:1022,target_id:iPurpose,param1:gfd.cards[actor.game_card_id].pos_id});_addStoneNoroiCost(gfd.cards[iPurpose]);}break;case 'charge':aQueue={actor_id:actor.game_card_id,log_message:'気合だめ',resolved_flg:0,priority:'command',queue_units:[{queue_type_id:1024,target_id:actor.game_card_id,cost_flg:true},{queue_type_id:1026,target_id:actor.game_card_id,param1:100}]};_addStoneNoroiCost(gfd.cards[aQueue.actor_id]);break;case 'escape':aQueue={actor_id:actor.game_card_id,log_message:'逃走',resolved_flg:0,priority:'command',queue_units:[{queue_type_id:1023,target_id:actor.game_card_id,cost_flg:true},{queue_type_id:1024,target_id:actor.game_card_id,cost_flg:true},{queue_type_id:1008,target_id:actor.game_card_id}]};_addStoneNoroiCost(gfd.cards[aQueue.actor_id]);if(gfd.cards[actor.game_card_id].status){if(gfd.cards[actor.game_card_id].status[114]){aQueue=null;}}break;case 'marigan':aQueue={actor_id:actor.game_card_id,log_message:'マリガンを使用',resolved_flg:0,priority:'command',queue_units:(function(){var q=[{queue_type_id:1027,target_id:actor.game_card_id,param1:132,cost_flg:true},{queue_type_id:1024,target_id:actor.game_card_id,cost_flg:true}];var iHands=0;var aGameCardId=[];$.each(gfd.cards,function(l,val){if(val.owner=='my'){if(val.pos_category=='hand'){iHands++;q.push({queue_type_id:1031,target_id:l,cost_flg:true});aGameCardId.push(l);}else if(val.pos_category=='deck'){aGameCardId.push(l);}}});aGameCardId.sort(function(){return rgn.rand(0,1)-0.5;});var iSortNo=1000;$.each(aGameCardId,function(k,l){q.push({queue_type_id:1012,target_id:l,param1:iSortNo++});});q.push({queue_type_id:1011,target_id:actor.game_card_id,param1:'draw',param2:iHands});return q;})()};_addStoneNoroiCost(gfd.cards[aQueue.actor_id]);break;case 'make_card':if(gfr.checkGameState()!='standby_game'){aQueue={actor_id:actor.game_card_id,log_message:'メイクカードを使用',resolved_flg:0,priority:'command',queue_units:[{queue_type_id:1011,target_id:actor.game_card_id,param1:'draw',param2:1},{queue_type_id:1023,target_id:actor.game_card_id,cost_flg:true},{queue_type_id:1024,target_id:actor.game_card_id,cost_flg:true}]};_addStoneNoroiCost(gfd.cards[aQueue.actor_id]);}break;case 'surrender':if(gfr.checkGameState()!='standby_game'){aQueue={actor_id:actor.game_card_id,log_message:'降参',resolved_flg:0,priority:'system',queue_units:(function(){var q=[];try{$.each(gfd.cards[actor.game_card_id].status,function(iStatusId,val){q.push({queue_type_id:1027,target_id:actor.game_card_id,param1:iStatusId});});}catch(e){}q.push({queue_type_id:1008,target_id:actor.game_card_id,param1:'surrender'});return q;})()};}break;case 'lvup':aQueue={actor_id:actor.game_card_id,log_message:'レベルアップ',resolved_flg:0,priority:'command',queue_units:(function(){var q=[];if(!gfd.lvup_magic_flg){q.push({queue_type_id:1004,target_id:actor.game_card_id,param1:-1,cost_flg:true});}q.push({queue_type_id:1019,target_id:actor.game_card_id});return q;})()};break;}if(aQueue){if((gfd.now_finished && aQueue.priority=='command')||gfd.already_finished){gfd.actor={game_card_id:null};gfr.updateField({field_data:gfd});}else{gfd.queues.push(aQueue);gfd.actor={game_card_id:null};$('.actor').removeClass('actor');execQueue({resolve_all:true});}}};try{var actor=gfd.actor;if(!actor.aTargets){actor.aTargets=[];}var actorMon=gfd.cards[actor.game_card_id];var aTargetInfo={game_card_id:aArgs.oDom.attr('game_card_id'),pos_id:aArgs.oDom.attr('id')};if(aTargetInfo.pos_id){aTargetInfo.game_card_id=gfr.getGameCardId({pos_category:'field',pos_id:aArgs.oDom.attr('id')});}switch(actor.act_type){case 'into_field':bRangeOk=gfr.checkTargetPosValid({actor_id:actor.game_card_id,target_id:aTargetInfo.game_card_id,target_pos_id:aTargetInfo.pos_id,range_type_id:30});if(!bRangeOk){return false;}if(gfr.isProvoked({game_card_id:gfr.getGameCardId({pos_category:'field',pos_id:'myMaster'})})){gfu.myAlertInField({message:'マスターが挑発されています！'});return false;}actor.param1=aTargetInfo.pos_id;_addActionFromActorInfo();return true;break;case 'attack':if(gfu.attackRangeCheck(actorMon,gfd.cards[aTargetInfo.game_card_id])){actor.aTargets.push(aTargetInfo);_addActionFromActorInfo();return true;}break;case 'arts':bRangeOk=gfr.checkTargetPosValid({actor_id:actor.game_card_id,target_id:aTargetInfo.game_card_id,target_pos_id:aTargetInfo.pos_id,range_type_id:gmd.m_arts[actor.art_id].range_type_id,target_order:actor.aTargets.length,art_flg:true});if(!bRangeOk){return false;}$('#game_field #'+aTargetInfo.pos_id).addClass('target');$('div.hand_card[game_card_id='+aTargetInfo.game_card_id+']').addClass('target');actor.aTargets.push(aTargetInfo);_addActionFromActorInfo();return true;break;case 'magic':bRangeOk=gfr.checkTargetPosValid({actor_id:actor.game_card_id,target_id:aTargetInfo.game_card_id,target_pos_id:aTargetInfo.pos_id,range_type_id:gmd.m_magic[actor.magic_id].range_type_id,target_order:actor.aTargets.length});if(!bRangeOk){return false;}if(gfr.isProvoked({game_card_id:gfr.getGameCardId({pos_category:'field',pos_id:'myMaster'})})){gfu.myAlertInField({message:'マスターが挑発されています！'});return false;}$('#game_field #'+aTargetInfo.pos_id).addClass('target');$('div.hand_card[game_card_id='+aTargetInfo.game_card_id+']').addClass('target');actor.aTargets.push(aTargetInfo);_addActionFromActorInfo();return true;break;case 'move':bRangeOk=gfr.checkTargetPosValid({actor_id:actor.game_card_id,target_pos_id:aTargetInfo.pos_id,range_type_id:12});if(!bRangeOk){return false;}actor.param1=aTargetInfo.pos_id;_addActionFromActorInfo();return true;break;case 'charge':case 'escape':case 'make_card':case 'marigan':case 'surrender':if(actor.game_card_id==aTargetInfo.game_card_id){_addActionFromActorInfo();return true;}break;case 'lvup':_addActionFromActorInfo();return true;break;}}catch(e){}return bRangeOk;}function execQueue(aArgs){delete gfd.tokugi_fuuji_flg;gfd.actor={game_card_id:null};gfr.updateActorDom();var bRecursive=aArgs.resolve_all;var act=gfd.queues;var bAllResolved=true;var aExecAct=null;var bOldQueue=false;if(gfd.pause_off_push){gfd.pause_flg=0;}else if(gfd.pause_on_push){gfd.pause_flg=1;}gfd.pause_on_push=gfd.pause_off_push=0;if(gfd.pause_flg){return;}if(0 < gfd.old_queues.length){bAllResolved=false;bOldQueue=true;aExecAct=gfd.old_queues.shift();}else{for(var i=0;i < act.length;i++){if(act[i].resolved_flg){continue;}bAllResolved=false;if(aExecAct==null||gmd.queue_priority[aExecAct.priority] < gmd.queue_priority[act[i].priority]){aExecAct=act[i];}}}if(!bAllResolved){(function _execAnimationUnitOneQueue(){aExecAct.failure_flg=false;aExecAct.resolved_flg=true;var bMoveQueueResolved=false;var bEffectQueueResolved=false;var bProvoked=gfr.isProvoked({game_card_id:aExecAct.actor_id});var bIgnoreProvoke=false;if(aExecAct.priority!='command'||bOldQueue){bIgnoreProvoke=true;}var backupFieldWhileSingleActionProcessing={};$.extend(true,backupFieldWhileSingleActionProcessing,gfd);if(aExecAct.priority=='command'){g_backup_field_data={};$.extend(true,g_backup_field_data,gfd);}var backupQueuesWhileOldQueueProcessing=null;(function(a){if(bOldQueue){backupQueuesWhileOldQueueProcessing=[];$.extend(true,backupQueuesWhileOldQueueProcessing,gfd.queues);}else{$.each(a.queue_units,function(i,q){switch(Number(q.queue_type_id)){case 1001:case 1005:case 1006:if(bProvoked){var iTargetId=Number(q.target_id);var iProvokerId=Number(gfd.cards[a.actor_id].status[117].param1);if(iTargetId==iProvokerId){bIgnoreProvoke=true;gfd.queues.push({actor_id:a.actor_id,log_message:'挑発解除',resolved_flg:0,priority:'follow',queue_units:[{queue_type_id:1027,target_id:a.actor_id,param1:117}]});}}var mon=gfd.cards[q.target_id];if(mon.status!=undefined){if(mon.status[115]!=undefined){if(rgn.rand(0,1)){q.queue_type_id=9999;q.param1='omamori';}}}break;}});var _b={};$.extend(true,_b,a);gfd.resolved_queues.push(_b);}})(aExecAct);try{var iAnimes=gfd.animation_info.animations.length;var iActorAnimes=0;if(!aExecAct.actor_anime_disable){if(typeof gfd.cards[aExecAct.actor_id]!='undefined'){if(gfd.cards[aExecAct.actor_id].pos_category=='field'){var sDom='#'+gfd.cards[aExecAct.actor_id].pos_id;for(var i=0;i < 2;i++){gfd.animation_info.animations.push({target_dom:sDom,animation_time_rate:0.5,animation_param:{'background-color':'#0e0'}});gfd.animation_info.animations.push({target_dom:sDom,animation_time_rate:0.5,animation_param:{'background-color':g_base_color.background}});}iActorAnimes=gfd.animation_info.animations.length-iAnimes;iAnimes=gfd.animation_info.animations.length;}}}var _insertDrawAnimation=function(_q){if(gfd.cards[_q.target_id].owner=='my'){var posId='#myPlayersInfo div.hand';}else{var posId='#enemyPlayersInfo div.hand';}for(var i=0;i < 2;i++){gfd.animation_info.animations.push({target_dom:posId,animation_param:{'opacity':'hide'}});gfd.animation_info.animations.push({target_dom:posId,animation_param:{'opacity':'show'}});}};var _checkScapeGoat=function(t){try{var a=gfd.cards[t.status[125].param1];if(a){t=a;}}catch(e){}return t;};for(var iterator_of_queue_now_proc=0;iterator_of_queue_now_proc < aExecAct.queue_units.length;iterator_of_queue_now_proc++){var q=aExecAct.queue_units[iterator_of_queue_now_proc];if(typeof q!='object'){continue;}q.failure_flg=true;var backupFieldWhileSingleQueueProcessing={};$.extend(true,backupFieldWhileSingleQueueProcessing,gfd);try{var bAsphyxia=(function(){try{if(q.queue_type_id==1022){return false;}if(aExecAct.priority.indexOf('system')!=-1){return false;}var mon=gfd.cards[q.target_id];var aMonsterData=gmd.m_monster[mon.monster_id];if(aMonsterData.skill.id==32){return true;}}catch(e){}return false;})();if(bAsphyxia){throw new Error('Asphyxia.');}switch(q.queue_type_id){case 1000:var sHtml='<input type="hidden" name="field_data" value=\''+JSON.stringify(gfd)+'\' />';$('form[name=form_current_field]').append(sHtml);gfr.updateField({field_data:gfd});var iAnimationTime=parseInt($('[name=animation_speed]:checked').val());setTimeout(function(){document.form_current_field.submit();},(isNaN(iAnimationTime)? 100:iAnimationTime));break;case 1001:var actorMon=gfd.cards[aExecAct.actor_id];var aMonsterData=gmd.m_monster[actorMon.monster_id];var targetMon=gfd.cards[q.target_id];targetMon=_checkScapeGoat(targetMon);if(targetMon.hp <=0){throw new Error('target already dead');}var pow=Number(aMonsterData.attack.power);if(actorMon.status[131]){pow+=Number(actorMon.status[131].param1);}if(actorMon.status[100]){pow++;}pow=calcPow(aExecAct.actor_id,targetMon.game_card_id,pow);if(0 < pow){targetMon.hp-=pow;}gfr.damageReaction({field_data:gfd,actor_id:aExecAct.actor_id,priority:aExecAct.priority,target_id:targetMon.game_card_id,damage:pow,attack_flg:true});break;case 1002:var mon=gfd.cards[aExecAct.actor_id];var p=gfu.getXYFromPosId(mon.pos_id);if(gfd.no_arrange &&(p.y==1||p.y==2)){var _checkDeathSheep=function(dy){try{var l=gfr.getGameCardId({'pos_category':'field','pos_id':gfu.getRelativePosId(mon.pos_id,{x:0,y:dy})});var death=gfd.cards[l];if(death){if(death.standby_flg){return false;}var aMonsterData=gmd.m_monster[death.monster_id];if(aMonsterData.skill.id==33){return true;}}}catch(e){}return false;};if(_checkDeathSheep(1)||_checkDeathSheep(-1)){throw new Error('fuuin');}}gfr.artsUsedReaction({field_data:gfd,actor_id:mon.game_card_id});break;case 1003:var sPosId='#myMaster .pict';var mon=gfd.cards[aExecAct.actor_id];var sImgSrc=gfu.getImg('/images/card/'+gmd.m_card[mon.card_id].image_file_name);if(mon.owner!='my'){sPosId='#enemyMaster .pict';}gfd.animation_info.animations.push({target_dom:sPosId,html_param:'<img class="card_image" src="'+sImgSrc+'" />',animation_param:{}});break;case 1004:var sOwner=gfd.cards[q.target_id].owner;var _updStone=function(iBefore,upd){var iRet=iBefore;try{if(upd=='harf'){iRet-=iBefore % 2;iRet /=2;}else{iRet+=Number(upd);}}catch(e){}return iRet;};if(sOwner=='my'){gfd.my_stone=_updStone(gfd.my_stone,q.param1);if(gfd.my_stone < 0){if(q.cost_flg){throw new Error('minus_stone');}else{gfd.my_stone=0;}}var posId='#myPlayersInfo div.stone';}else if(sOwner=='enemy'){gfd.enemy_stone=_updStone(gfd.enemy_stone,q.param1);if(gfd.enemy_stone < 0){if(q.cost_flg){throw new Error('minus_stone');}else{gfd.enemy_stone=0;}}var posId='#enemyPlayersInfo div.stone';}else{throw new Error('no_target');}gfd.animation_info.animations.push({target_dom:posId,animation_param:{'opacity':'hide'}});gfd.animation_info.animations.push({target_dom:posId,animation_param:{'opacity':'show'}});break;case 1005:var targetMon=gfd.cards[q.target_id];targetMon=_checkScapeGoat(targetMon);if(targetMon.standby_flg){throw new Error('target is standby');}if(targetMon.next_game_card_id){throw new Error('next_game_card_id is not null');}if(targetMon.hp <=0){throw new Error('target already dead');}switch(q.param2){case 'drill_break':var p=gfu.getXYFromPosId(gfd.cards[aExecAct.actor_id].pos_id);if(p.x==0){p.x=2;}else{p.x=0;}var sPartnerId=gfr.getGameCardId({'pos_category':'field','pos_id':gfu.getPosIdFromXY(p)});var pow=calcPow(aExecAct.actor_id,targetMon.game_card_id,q.param1);pow=calcPow(sPartnerId,null,pow);break;default:pow=calcPow(aExecAct.actor_id,targetMon.game_card_id,q.param1);break;}if(0 < pow){targetMon.hp-=pow;}gfr.damageReaction({field_data:gfd,actor_id:aExecAct.actor_id,priority:aExecAct.priority,target_id:targetMon.game_card_id,damage:pow});var sPosId='#'+targetMon.pos_id;gfd.animation_info.animations.push({target_dom:sPosId,css_param:{'background-color':'#f00'},animation_param:{'background-color':g_base_color.background}});break;case 1006:var targetMon=gfd.cards[q.target_id];targetMon=_checkScapeGoat(targetMon);if(targetMon.standby_flg){throw new Error('target is standby');}if(targetMon.next_game_card_id){throw new Error('next_game_card_id is not null');}if(targetMon.hp <=0){throw new Error('target already dead');}var dam=q.param1;if(q.param2=='damage_noroi'){if(!targetMon.status[122]){throw new Error('damage_noroi_inactive');}dam=targetMon.hp-1;if(dam <=0){throw new Error('argument_error');}}var dam=calcDam(aExecAct.actor_id,targetMon.game_card_id,dam);if(0 < dam){targetMon.hp-=dam;}gfr.damageReaction({field_data:gfd,actor_id:aExecAct.actor_id,priority:aExecAct.priority,target_id:targetMon.game_card_id,damage:dam});var sPosId='#'+targetMon.pos_id;gfd.animation_info.animations.push({target_dom:sPosId,css_param:{'background-color':'#f00'},animation_param:{'background-color':g_base_color.background}});break;case 1007:q.param1=parseInt(q.param1);if(0 < q.param1){var targetMon=gfd.cards[q.target_id];if(targetMon.next_game_card_id){throw new Error('next_game_card_id is not null');}var iMaxHP=gfu.getMaxHP(targetMon);targetMon.hp+=q.param1;if(iMaxHP < targetMon.hp){targetMon.hp=iMaxHP;}gfr.healReaction({field_data:gfd,actor_id:aExecAct.actor_id,target_id:q.target_id,heal:q.param1});}(function _addHealAnimation(){var sPosId='#'+targetMon.pos_id;gfd.animation_info.animations.push({bParallels:true,target_dom:sPosId,animation_param:{'background-color':'#8f8'}});gfd.animation_info.animations.push({target_dom:sPosId+' img',animation_param:{'opacity':'hide'}});gfd.animation_info.animations.push({bParallels:true,target_dom:sPosId,animation_param:{'background-color':g_base_color.background}});gfd.animation_info.animations.push({target_dom:sPosId+' img',animation_param:{'opacity':'show'}});})();break;case 1008:var targetMon=gfd.cards[q.target_id];if(targetMon.pos_category!='field'){throw new Error('既にフィールドにいない');}$.each(gfd.cards,function(ii,vv){if(vv.pos_category!='field'){return true;}else if(!vv.pos_id){return true;}else if(vv.pos_id!=targetMon.pos_id){return true;}var iSortNo=1;$.each(gfd.cards,function(i,val){if(val.pos_category=='used'){if(iSortNo <=val.sort_no){iSortNo=val.sort_no+1;}}});vv.pos_category='used';vv.sort_no=iSortNo;});$.each(targetMon.status,function(iStatusId,val){var sStName=gmd.m_status[iStatusId].status_name;var q={actor_id:targetMon.game_card_id,log_message:'倒れたためステータス解除['+sStName+']',resolved_flg:0,actor_anime_disable:true,priority:'same_time',queue_units:[{queue_type_id:1027,target_id:targetMon.game_card_id,param1:iStatusId}]};switch(parseInt(iStatusId)){case 124:if(targetMon.owner=='my'){var iMasterId=gfr.getGameCardId({pos_category:'field',pos_id:'myMaster'});}else if(targetMon.owner=='enemy'){var iMasterId=gfr.getGameCardId({pos_category:'field',pos_id:'enemyMaster'});}q.queue_units.push({queue_type_id:1006,target_id:iMasterId,param1:1});break;}gfd.queues.push(q);});if(!bOldQueue){if(targetMon.pos_id=='myMaster'||targetMon.pos_id=='enemyMaster'){gfd.now_finished=true;}}gfd.queues.push({actor_id:targetMon.game_card_id,log_message:'LV分のストーンを還元',resolved_flg:0,actor_anime_disable:true,priority:'system',queue_units:[{queue_type_id:1004,target_id:targetMon.game_card_id,param1:gmd.m_monster[targetMon.monster_id].lv}]});gfd.animation_info.animations.push({target_dom:'#'+targetMon.pos_id+' .pict img',animation_param:{width:0,height:0,margin:'25px'}});break;case 1011:var mon=gfd.cards[q.target_id];if(q.param1=='draw' && q.param2 &&(mon.pos_id=='myMaster'||mon.pos_id=='enemyMaster')){(function(){var bPicked=false;for(var i=0;i < q.param2;i++){var l=gfr.getGameCardId({pos_category:'deck',owner:mon.owner,sort_type:'first'});if(l){bPicked=true;}else{if(!bPicked){throw new Error('デッキ切れ');}return;}gfd.cards[l].pos_category='hand';}})();}else{gfd.cards[q.target_id].pos_category='hand';}_insertDrawAnimation(q);break;case 1009:case 1015:gfd.cards[q.target_id].pos_category='hand';_insertDrawAnimation(q);break;case 1010:var targetMon=gfd.cards[q.target_id];if(targetMon.pos_category!='field'){throw new Error('invalid_target');}if(!targetMon.standby_flg){throw new Error('invalid_target');}delete targetMon.monster_id;targetMon=gfu.loadMonsterInfo({target_monster:targetMon,standby_flg:false,reset_hp:true,reset_act_count:true});gfr.wakeupReaction({field_data:gfd,actor_id:aExecAct.actor_id,target_id:q.target_id,system_flg:(aExecAct.priority.indexOf('system',0)!=-1)});gfd.animation_info.animations.push({target_dom:'#'+targetMon.pos_id+' img',animation_param:{width:0,left:'25px'}});break;case 1012:if(q.param1=='shuffle'){var sOwner=gfd.cards[q.target_id].owner;var arr=[];$.each(gfd.cards,function(l,val){if(val.owner!=sOwner||val.pos_category!='deck'){return true;}arr.push(l);});rgn.srand(Number(q.param2,20));arr.sort(function(){return rgn.rand(0,1)-0.5;});rgn.restore();var iSortNo=1000;$.each(arr,function(i,l){gfd.cards[l].sort_no=iSortNo++;});}else{gfd.cards[q.target_id].sort_no=q.param1;}break;case 1013:if(gfr.getGameCardId({pos_category:'field',pos_id:q.param1})){throw new Error('no_target');}var targetMon=gfd.cards[q.target_id];if(targetMon.pos_category!='hand'){}targetMon=gfu.loadMonsterInfo({target_monster:targetMon,pos_id:q.param1,standby_flg:true,reset_hp:true});break;case 1014:var target=gfd.cards[q.target_id];if(target.pos_category!='hand'){throw new Error('invalid_target');}var iSortNo=1;$.each(gfd.cards,function(i,val){if(val.pos_category=='used'){if(iSortNo <=val.sort_no){iSortNo=val.sort_no+1;}}});target.pos_category='used';target.sort_no=iSortNo;break;case 1016:mon=gfu.loadMonsterInfo({target_monster:mon,check_blank:true,reset_hp:true});break;case 1017:var mon=gfd.cards[q.target_id];var bAssist=false;if(gmd.m_monster[mon.monster_id].skill){if(gmd.m_monster[mon.monster_id].skill.id==11){bAssist=true;}}if(bAssist){if(gfd.no_arrange){gfd.lvup_assist+=parseInt(q.param1);}else{gfd.lvup_assist+=1;}}else if(gfr.isLvupOk(mon)){mon.lvup_standby+=parseInt(q.param1);}else{throw new Error('invalid_target');}if(q.param2){gfd.lvup_magic_flg=true;}else{try{delete gfd.lvup_magic_flg;}catch(e){}}break;case 1018:gfd.lvup_assist=0;$.each(gfd.cards,function(i,vval){if(vval.lvup_standby){vval.lvup_standby=0;}});try{delete gfd.lvup_magic_flg;}catch(e){}break;case 1019:var mon=gfd.cards[q.target_id];var aMonsterData=gmd.m_monster[mon.monster_id];if(mon.status){$.each([ 111,121,127,128 ],function(i,v){if(mon.status[v]){throw new Error('invalid_target');}});}if(0 < mon.lvup_standby){mon.lvup_standby--;}else if(0 < gfd.lvup_assist){gfd.lvup_assist--;}else{throw new Error('invalid_target');}if(q.param1){var aSuperInHand=gfd.cards[q.param1];var bSuper=gfu.isValidSuper({aBefore:gfd.cards[q.target_id],aAfter:aSuperInHand});if(!bSuper){throw new Error('invalid_target');}mon.next_game_card_id=q.param1;aSuperInHand.monster_id=gmd.m_card[aSuperInHand.card_id].monster_id;aSuperInHand=gfu.loadMonsterInfo({target_monster:aSuperInHand,pos_id:mon.pos_id,reset_hp:true,aBefore:gfd.cards[q.target_id]});aSuperInHand.lvup_standby=mon.lvup_standby;mon.lvup_standby=0;}else if(aMonsterData.next_monster_id){mon=gfu.loadMonsterInfo({target_monster:mon,monster_id:aMonsterData.next_monster_id,reset_hp:true});}else{throw new Error('argument_error');}gfd.animation_info.animations.push({target_dom:'#'+mon.pos_id,animation_param:{backgroundColor:'#00f'}});gfd.animation_info.animations.push({target_dom:'#'+mon.pos_id,animation_param:{backgroundColor:'#0f0'}});gfd.animation_info.animations.push({target_dom:'#'+mon.pos_id,animation_param:{backgroundColor:'#f00'}});gfd.animation_info.animations.push({target_dom:'#'+mon.pos_id,animation_param:{backgroundColor:'#ff0'}});gfd.animation_info.animations.push({target_dom:'#'+mon.pos_id,animation_param:{backgroundColor:'#fff'}});break;case 1020:var mon=gfd.cards[q.target_id];if(mon.lv <=1){throw new Error('invalid_target');}if(mon.status){$.each([ 111,121,127,128 ],function(i,v){if(mon.status[v]){throw new Error('invalid_target');}});}var bResolved=false;$.each(gmd.m_monster,function(i,val){if(val.next_monster_id==mon.monster_id){mon=gfu.loadMonsterInfo({target_monster:mon,monster_id:val.monster_id,reset_hp:true});bResolved=true;return false;}});if(!bResolved){var aBefore=gfd.cards[mon.before_game_card_id];if(typeof aBefore.next_game_card_id!='undefined'){delete aBefore.next_game_card_id;}aBefore.hp=gfu.getMaxHP(aBefore);var iSortNo=1;$.each(gfd.cards,function(i,val){if(val.pos_category=='used'){if(iSortNo <=val.sort_no){iSortNo=val.sort_no+1;}}});mon.pos_category='used';mon.sort_no=iSortNo;}gfd.queues.push({actor_id:q.target_id,log_message:'レベルダウンしたストーンを還元',actor_anime_disable:true,resolved_flg:0,priority:'same_time',queue_units:[{queue_type_id:1004,target_id:q.target_id,param1:1}]});(function _addLvDownAnimation(){gfd.animation_info.animations.push({target_dom:'#'+mon.pos_id,animation_param:{backgroundColor:'#000'}});gfd.animation_info.animations.push({target_dom:'#'+mon.pos_id,animation_param:{backgroundColor:'#fff'}});gfd.animation_info.animations.push({target_dom:'#'+mon.pos_id,animation_param:{backgroundColor:'#000'}});gfd.animation_info.animations.push({target_dom:'#'+mon.pos_id,animation_param:{backgroundColor:'#fff'}});})();break;case 1021:var mon=gfd.cards[q.target_id];mon=gfu.loadMonsterInfo({target_monster:mon,monster_id:q.param1,reset_hp:q.param2});var sDom='#'+mon.pos_id+' div.pict';var sImgSrc='/images/card/'+gmd.m_monster[mon.monster_id].image_file_name;sImgSrc=gfu.getImg(sImgSrc);gfd.animation_info.animations.push({target_dom:sDom,html_param:'<img src="'+sImgSrc+'" />'});gfd.animation_info.animations.push({target_dom:sDom+' img',css_param:{opacity:0,margin:'25px',height:0,width:0},animation_param:{margin:0,height:'50px',width:'50px',opacity:1}});break;case 1022:var p=gfu.getXYFromPosId(q.param1);var aCard=gfd.cards[q.target_id];var bSystem=(aExecAct.priority.indexOf('system',0)!=-1);if(aCard.next_game_card_id){throw new Error('before_game_card_id is not null');}if(gmd.m_card[aCard.card_id].category=='master'){throw new Error('invalid_target');}if(aCard.pos_category!='field'){throw new Error('invalid_target');}if(q.param2=='front_slide'){var oRelative={x:0,y:-1};if(aCard.owner!='my'){oRelative.y=1;}q.param1=gfu.getRelativePosId(aCard.pos_id,oRelative);p=gfu.getXYFromPosId(q.param1);}var bKagenui=(function _chkKagenui(){var bK=false;try{if(aCard.status[114]){bK=true;}}catch(e){}if(bK){var sType='command';if(q.param2=='front_slide'){sType='slide';}else if(bSystem){sType='system';}switch(sType){case 'system':return false;case 'slide':if(gfd.no_arrange){return false;}return true;default:return true;}}return false;})();if(bKagenui){throw new Error('Move failed. Mover has kagenui.');}if((aCard.owner=='my' && 2 <=p.y)||(aCard.owner=='enemy' && p.y <=1)){aCard.pos_id=q.param1;if(aCard.before_game_card_id && typeof gfd.cards[aCard.before_game_card_id]!='undefined'){gfd.cards[aCard.before_game_card_id].pos_id=q.param1;}bMoveQueueResolved=true;if(!bSystem && aCard.status){if(aCard.status[116]){gfd.queues.push({actor_id:aCard.game_card_id,log_message:'移動したのでダークホール効果消滅',resolved_flg:0,priority:'follow',queue_units:[{queue_type_id:1027,target_id:aCard.game_card_id,param1:116}]});}}(function(){var sDom='#'+q.param1;for(var i=0;i < 2;i++){gfd.animation_info.animations.push({target_dom:sDom,animation_param:{'background-color':'#ee0'}});gfd.animation_info.animations.push({target_dom:sDom,animation_param:{'background-color':g_base_color.background}});}})();}else{throw new Error('move_to_opponent_field');}break;case 1023:var aCard=gfd.cards[q.target_id];if(!q.param1){q.param1=1;}if(aCard.owner=='my'){var l=gfr.getGameCardId({pos_category:'field',pos_id:'myMaster'});}else if(aCard.owner=='enemy'){var l=gfr.getGameCardId({pos_category:'field',pos_id:'enemyMaster'});}var mon=gfd.cards[l];mon.hp-=q.param1;if(mon.hp <=0){gfd.queues.push({actor_id:mon.game_card_id,log_message:'ペナルティによりマスター消滅',resolved_flg:0,priority:'system',queue_units:[{queue_type_id:1008,target_id:mon.game_card_id}]});}break;case 1024:var mon=gfd.cards[q.target_id];mon.act_count++;if(!bOldQueue){var nMaxAct=gfu.getMaxActCount(mon.monster_id);if(mon.standby_flg){throw new Error('invalid_actor');}if(nMaxAct < mon.act_count){throw new Error('already_acted');}if(mon.status){if(mon.status[129]){throw new Error('invalid_actor');}}gfr.actedReaction({actor_id:aExecAct.actor_id,target_id:q.target_id});}break;case 1025:var mon=gfd.cards[q.target_id];var aCardData=gmd.m_card[mon.card_id];if(aCardData.category=='master'){throw new Error('invalid_target');}mon.status[100]={status_id:100,turn_count:1000};break;case 1026:var mon=gfd.cards[q.target_id];if(mon.standby_flg){throw new Error('standby_monster');}q.param1=Number(q.param1);if(gmd.m_card[mon.card_id].category=='master'){switch(q.param1){case 101:case 103:case 104:case 110:case 115:case 117:case 118:case 120:case 121:case 122:case 123:case 125:case 129:case 130:case 132:break;default:throw new Error('invalid_param');}}if(q.param1==131){if(typeof mon.status[131]=='undefined'){mon.status[131]={status_id:131,turn_count:1000,param1:1};}else{mon.status[131].param1++;}break;}var aAlreadyStatus={};$.each(mon.status,function(iStatusId,val){var aSt=gmd.m_status[iStatusId];switch(aSt.status_type){case 'P':case 'S':aAlreadyStatus[aSt.status_type]=true;aAlreadyStatus[iStatusId]=true;break;default:aAlreadyStatus[iStatusId]=true;break;}});var aSt=gmd.m_status[q.param1];var iTurnCount=Number(aSt.turn_count);switch(aSt.status_type){case 'P':case 'S':if(aAlreadyStatus[aSt.status_type]){throw new Error('duplicate_status_type');}break;default:if(aAlreadyStatus[aSt.status_id]){throw new Error('duplicate_status_id');}break;}mon.status[q.param1]={status_id:q.param1,turn_count:iTurnCount};switch(q.param1){case 110:case 117:case 118:case 119:case 120:case 125:case 126:mon.status[q.param1].param1=q.param2;break;case 121:case 127:mon.status[q.param1].param1=mon.monster_id;mon.monster_id=q.param2;mon.card_id=gmd.m_monster[mon.monster_id].card_id;break;case 128:mon.status[q.param1].param1=mon.monster_id;mon.monster_id=gmd.m_card[2].monster_id;break;}var sDom='#'+mon.pos_id;gfd.animation_info.animations.push({target_dom:sDom,animation_param:{'background-color':'#ee0'}});gfd.animation_info.animations.push({target_dom:sDom,animation_param:{'background-color':g_base_color.background}});break;case 1027:q.param1=Number(q.param1);var mon=gfd.cards[q.target_id];if(!mon.status[q.param1]){throw new Error('no_target');}var iDelSt=null;switch(q.param1){case 121:case 127:case 128:mon.monster_id=mon.status[q.param1].param1;mon.card_id=gmd.m_monster[mon.monster_id].card_id;if(gfu.getMaxHP(mon)< mon.hp){mon.hp=gfu.getMaxHP(mon);}break;case 118:iDelSt=117;break;case 117:iDelSt=118;break;case 119:iDelSt=119;break;case 125:iDelSt=126;break;case 126:iDelSt=125;break;}if(iDelSt){gfd.queues.push({actor_id:mon.status[q.param1].param1,log_message:'対になっているモンスターのステータスも同時解除',resolved_flg:0,priority:'same_time',actor_anime_disable:true,queue_units:[{queue_type_id:1027,target_id:mon.status[q.param1].param1,param1:iDelSt}]});}delete mon.status[q.param1];break;case 1028:gfd.cards[q.target_id].skill_disable_flg=1;break;case 1029:gfd.cards[q.target_id].skill_disable_flg=0;break;case 1030:gfd.cards[q.target_id].act_count=0;break;case 1031:var mon=gfd.cards[q.target_id];var st='last';if(q.param1=='first'){st='first';}var l=gfr.getGameCardId({pos_category:'deck',owner:mon.owner,sort_type:st});var aCard=gfd.cards[l];mon.pos_category='deck';if(st=='first'){mon.sort_no=aCard.sort_no-1;}else{mon.sort_no=aCard.sort_no+1;}break;case 1032:q.param1=Number(q.param1);var mon=gfd.cards[q.target_id];var aSt=mon.status[q.param1];aSt.turn_count--;if(aSt.turn_count <=0){gfd.queues.push({actor_id:mon.game_card_id,log_message:'効果時間が切れたため、ステータス解除',resolved_flg:0,priority:'system',actor_anime_disable:true,queue_units:[{queue_type_id:1027,target_id:mon.game_card_id,param1:q.param1}]});if(q.param1==116){gfd.queues.push({actor_id:mon.game_card_id,log_message:'ダークホールにより消滅',resolved_flg:0,priority:'follow',queue_units:[{queue_type_id:1008,target_id:mon.game_card_id}]});}}break;case 9999:switch(q.param1){case 'regenerate':var mon=gfd.cards[q.target_id];if(mon.before_game_card_id){mon.pos_category='used';var tmp=mon.before_game_card_id;delete mon.before_game_card_id;mon=gfd.cards[tmp];delete mon.next_game_card_id;}var a=gmd.m_card[mon.card_id].monster_id;mon=gfu.loadMonsterInfo({target_monster:mon,monster_id:a,reset_hp:true,reset_status:true,reset_act_count:true});break;case 'omamori':break;case 'suka':break;case 'sort_card':if(!bOldQueue){gfd.sort_card_flg=true;}var mon=gfd.cards[q.target_id];var aPicks=[];$.each(gfd.cards,function(l,val){if(val.owner==mon.owner && val.pos_category=='deck'){aPicks.push({game_card_id:l,sort_no:val.sort_no ? parseInt(val.sort_no):0});}});aPicks.sort(function(v1,v2){return v1.sort_no-v2.sort_no;});gfd.sorting_cards=[];for(var i=0;i < 5;i++){gfd.sorting_cards.push(aPicks.shift());}break;case 'old_turn_end':if(q.param2){startingProc();bOldQueue=false;}(function(){$('#game_infomation_frame .info').text('ターン終了');gfd.animation_info.animations.push({target_dom:'#myMaster img,#myMaster img',animation_time_rate:2,animation_param:{'width':'52px'}});})();break;case 'game_end_check':if(isGameEnd()){gfd.already_finished=true;}break;default:throw new Error('9999 argument_error['+q.param1+']');break;}break;default:throw new Error('invalid_queue_type');break;}delete q.failure_flg;if(!q.cost_flg){bEffectQueueResolved=true;}}catch(e){if(q.cost_flg){throw e;}gfd=backupFieldWhileSingleQueueProcessing;}}if(!bEffectQueueResolved){throw new Error('no_q_resolved');}if(bMoveQueueResolved){if(gfr.isDuplicateFieldPos({field_data:gfd})){throw new Error('duplicate_field_pos');}}if(bProvoked && !bIgnoreProvoke){throw new Error('action_prevented_for_provoke');}if(iAnimes==gfd.animation_info.animations.length){gfd.animation_info.animations=[];}$('#log_list').prepend('<li>'+aExecAct.log_message+'</li>');delete aExecAct.failure_flg;}catch(e){gfd=backupFieldWhileSingleActionProcessing;}if(bOldQueue){gfd.queues=backupQueuesWhileOldQueueProcessing;}setTimeout(function(){execAnimation(bRecursive);},0);})();}else{(function(){$.each(gfd.cards,function(l,val){if(val.pos_category!='field'){removeMonsterInfoOnField(l);}});})();}}function execAnimation(bRecursive){var _execAnimationUnit=function(bRecursive){try{var iAnimationTime=parseInt($('[name=animation_speed]:checked').val());if(isNaN(iAnimationTime)||iAnimationTime <=0){throw new Error('no_setting');}}catch(e){iAnimationTime=100;}if(0 < gfd.animation_info.animations.length){try{var aArgs=gfd.animation_info.animations.shift();if($(aArgs.target_dom).size()<=0){throw '';}if(aArgs.html_param){$(aArgs.target_dom).html(aArgs.html_param);}if(aArgs.css_param){$.each(aArgs.css_param,function(key,val){$(aArgs.target_dom).css(key,val);});}if(aArgs.animation_time_rate){iAnimationTime *=aArgs.animation_time_rate;}if(aArgs.bParallels){_execAnimationUnit(bRecursive);}$(aArgs.target_dom).animate(aArgs.animation_param,iAnimationTime,'linear',function(){if(!aArgs.bParallels){_execAnimationUnit(bRecursive);}});}catch(e){setTimeout(function(){_execAnimationUnit(bRecursive);},0);}}else{gfd.animation_info.bAnimationProcessing=false;$('#game_field td[style]').removeAttr('style');var iNextInterval=1;if(0 < gfd.old_queues.length){try{var iOld=parseInt($('[name=old_animation_speed]:checked').val());if(isNaN(iOld)||iOld <=0){throw new Error('no_setting');}}catch(e){iOld=200;}iNextInterval=iOld;}setTimeout(function(){$('.temp_animation').remove();if(bRecursive){execQueue({resolve_all:true});}},iNextInterval);gfr.updateField({field_data:gfd});}};if(!gfd.animation_info.bAnimationProcessing){gfd.animation_info.bAnimationProcessing=true;$('.actor').removeClass('actor');$('.target').removeClass('target');_execAnimationUnit(bRecursive);}else{return;}}function calcPow(actorId,targetId,pow){try{pow=Number(pow);if(isNaN(pow)||pow < 0){throw new Error('minus_power');}var act=gfd.cards[actorId];if(targetId){var target=gfd.cards[targetId];if(target==null){throw new Error('no_target');}if(gmd.m_monster[target.monster_id].skill.id==32){return 0;}if(target.status){if(target.status[112]){return 0;}}}if(act && act.status){if(act.status[101]!=null){pow++;gfd.queues.push({actor_id:actorId,log_message:'パワーアップ効果発揮',resolved_flg:0,priority:'same_time',actor_anime_disable:true,queue_units:[{queue_type_id:1027,param1:101,target_id:actorId}]});}if(act.status[102]!=null){pow++;gfd.queues.push({actor_id:actorId,log_message:'バーサクパワー効果発揮',resolved_flg:0,priority:'same_time',queue_units:[{queue_type_id:1006,param1:1,target_id:actorId},{queue_type_id:1027,param1:102,target_id:actorId,cost_flg:true}]});}if(act.status[103]!=null){pow=2;gfd.queues.push({actor_id:actorId,log_message:'パワー２効果発揮',resolved_flg:0,priority:'same_time',actor_anime_disable:true,queue_units:[{queue_type_id:1027,param1:103,target_id:actorId}]});}if(act.status[104]!=null){if(pow > 0){pow--;}gfd.queues.push({actor_id:actorId,log_message:'パワーダウン効果発揮',resolved_flg:0,priority:'same_time',actor_anime_disable:true,queue_units:[{queue_type_id:1027,param1:104,target_id:actorId}]});}if(act.status[105]!=null){pow+=2;}if(act.status[130]!=null){pow+=2;gfd.queues.push({actor_id:actorId,log_message:'パワーチャージLV2効果発揮',resolved_flg:0,priority:'same_time',actor_anime_disable:true,queue_units:[{queue_type_id:1027,param1:130,target_id:actorId}]});}}if(!targetId){return pow;}if(pow && gmd.m_card[target.card_id].category=='master'){pow-=2;if(pow < 0){pow=0;}}if(pow && target.status[106]!=null){pow--;}if(pow && target.status[107]!=null){pow=parseInt(pow / 2);gfd.queues.push({actor_id:targetId,log_message:'ガラスの盾 効果発揮',resolved_flg:0,priority:'same_time',actor_anime_disable:true,queue_units:[{queue_type_id:1027,param1:107,target_id:targetId}]});}if(pow && target.status[108]!=null){pow=parseInt(pow / 2);}if(pow && target.status[109]!=null){pow--;}if(pow && target.status[100]!=null){pow--;gfd.queues.push({actor_id:targetId,log_message:'気合溜め 防御効果発揮',resolved_flg:0,priority:'same_time',actor_anime_disable:true,queue_units:[{queue_type_id:1027,param1:100,target_id:targetId}]});}if(pow < 0){throw new Error('minus_power');}else if(target.hp < pow){pow=target.hp;}}catch(e){switch(e){case 'no_target':case 'minus_power':return 0;default:throw e;}}return pow;}function calcDam(actorId,targetId,dam){try{dam=Number(dam);if(isNaN(dam)||dam < 0){throw new Error('minus_power');}var act=gfd.cards[actorId];var target=gfd.cards[targetId];if(target==null){throw new Error('no_target');}if(gmd.m_monster[target.monster_id].skill.id==32){return 0;}if(target.status){if(target.status[112]){return 0;}}if(dam && target.status[100]!=null){gfd.queues.push({actor_id:targetId,log_message:'気合溜め解除',resolved_flg:0,priority:'same_time',actor_anime_disable:true,queue_units:[{queue_type_id:1027,param1:100,target_id:targetId}]});}if(target.hp < dam){dam=target.hp;}}catch(e){switch(e){case 'no_target':case 'minus_power':return 0;default:throw e;}}return dam;}function removeMonsterInfoOnField(target_id){var mon=gfd.cards[target_id];if(typeof mon.status!='undefined'){$.each(mon.status,function(iSt,aSt){var sid=null;switch(Number(iSt)){case 117:sid=118;break;case 118:sid=117;break;case 119:sid=119;break;case 121:sid=121;break;case 125:sid=126;break;case 126:sid=125;break;}if(sid){gfd.queues.push({actor_id:null,resolved_flg:0,priority:'same_time',actor_anime_disable:true,queue_units:[{queue_type_id:1027,target_id:aSt.param1,param1:sid}]});}});}delete mon.monster_id;delete mon.pos_id;delete mon.hp;delete mon.standby_flg;delete mon.skill_disable_flg;delete mon.act_count;delete mon.lvup_standby;delete mon.status;delete mon.mad_hole_cnt;}function isGameEnd(){try{var my=gfr.getGameCardId({'pos_category':'field','pos_id':'myMaster'});var enemy=gfr.getGameCardId({'pos_category':'field','pos_id':'enemyMaster'});var enemyUsed=gfr.getGameCardId({'pos_category':'used','owner':'enemy','sort_type':'first'});if(enemyUsed &&(!my||!enemy)){return true;}}catch(e){}return false;}function turnEndProc(aArgs){if(typeof aArgs=='undefined'){aArgs={};}if(!aArgs.ignore_hand_num){var iHands=0;$.each(gfd.cards,function(i,val){if(val.owner=='my' && val.pos_category=='hand'){iHands++;}});if(iHandMax < iHands){gfd.end_phase_flg=true;var _delActorInfo=function(){gfd.actor={game_card_id:null};$('.actor').removeClass('actor');$('.target').removeClass('target');gfr.updateField({field_data:gfd});};_delActorInfo();$('#hand_card').css('backgroundColor','#fdd');return;}}$.each(gfd.cards,function(i,val){if(typeof val.monster_id!='undefined'){var aMonsterData=gmd.m_monster[val.monster_id];switch(aMonsterData.skill.id){case 32:gfd.queues.push({actor_id:val.game_card_id,log_message:'仮死から復活',resolved_flg:0,priority:'system',queue_units:[{queue_type_id:1021,target_id:val.game_card_id,param1:gfu.getModifyMonsterId(val.monster_id),param2:false}]});break;}if(typeof val.status!='undefined'){$.each(val.status,function(status_id,val2){if(val.pos_id=='myMaster' && Number(status_id)==132){gfd.queues.push({actor_id:val.game_card_id,log_message:'マリガン権消失',resolved_flg:0,priority:'system',queue_units:[{queue_type_id:1027,target_id:val.game_card_id,param1:status_id}]});}else{gfd.queues.push({actor_id:null,log_message:'ステータス継続時間を更新',resolved_flg:0,priority:'system',queue_units:[{queue_type_id:1032,target_id:val.game_card_id,param1:status_id}]});}});}if(val.owner=='my' && val.act_count < gfu.getMaxActCount(val.monster_id)&& !val.standby_flg){gfd.queues.push({actor_id:null,log_message:'行動してないので気合だめ',resolved_flg:0,priority:'system',queue_units:[{queue_type_id:1025,target_id:val.game_card_id}]})}}});gfd.queues.push({actor_id:null,log_message:'ターンエンド',resolved_flg:0,priority:'turn_end',queue_units:[{queue_type_id:1000}]});execQueue({resolve_all:true});}};